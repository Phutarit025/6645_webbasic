<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EPL Draft Duel — โหมดสมจริง (FPL รายสัปดาห์)</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;800&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #070b16;
        --panel: #0d1324;
        --soft: #111a2f;
        --ring: #223047;
        --muted: #a9b3c3;
        --pri: #22d3ee;
        --pri2: #818cf8;
        --ok: #34d399;
        --warn: #f59e0b;
        --bad: #ef4444;
        --text: #e7edf6;
      }
      /* ===================== Responsive overrides ===================== */

/* จอ ≤1200px: คอลัมน์หลักเหลือ 1, ปรับหัวข้อแถบติด */
@media (max-width: 1200px) {
  .grid-3 { grid-template-columns: 1fr; }
  .sticky-head { top: 58px; }
}

/* จอ ≤992px: ย่อการ์ดผู้เล่น/โลโก้, กระดานเหลือ 3 คอลัมน์, สรุปผลซ้อนบรรทัด */
@media (max-width: 992px) {
  .logo-picker { grid-template-columns: repeat(4, 1fr); }
  .players-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
  .formation { grid-template-columns: repeat(3, 1fr); }

  /* แถวสรุปผล: วางเป็นคอลัมน์เดียว */
  .row2 { grid-template-columns: 1fr; }
  .row2 > div:nth-child(2) { order: 3; margin: 8px 0; } /* แถบเปรียบเทียบไปอยู่กลาง */
}

/* จอ ≤768px: ปรับขนาดฟอนต์/ภาพ, ปุ่มเต็มบรรทัด, กระดานเหลือ 2 คอลัมน์ */
@media (max-width: 768px) {
  header .container { padding: 10px 12px; }
  .container { padding: 12px; }
  h1 { font-size: 18px; }

  .logo-pick img { width: 32px; height: 32px; }
  .avatar { width: 40px; height: 40px; }

  /* ปุ่มให้กดง่ายขึ้น */
  button { width: 100%; padding: 10px 12px; }
  .seg { width: 100%; }
  .seg button { flex: 1; }

  .chip, .badge { padding: 4px 8px; }

  .players-grid { grid-template-columns: 1fr 1fr; }
  .formation { grid-template-columns: repeat(2, 1fr); }
}

/* จอ ≤560px: เหลือ 1 คอลัมน์เกือบทั้งหมด, ลด padding ให้พอดีหน้าจอ */
@media (max-width: 560px) {
  .logo-picker { grid-template-columns: repeat(3, 1fr); }
  .players-grid { grid-template-columns: 1fr; }
  .summary-card { padding: 12px; }
  .p-card { padding: 8px; }
}

/* มือถือ (touch) ตัด sticky ออกเพื่อเลื่อนง่ายขึ้น */
@media (hover: none) and (pointer: coarse) {
  .sticky-head { position: static; }
  #teamsPlayers { max-height: none; }
}

      * { box-sizing: border-box; }
      body {
        margin: 0; color: var(--text); font-family: "Kanit", system-ui, Roboto;
        background: radial-gradient(1100px 800px at 10% -10%, #1b2440 0%, #0f1733 45%, #070b16 100%) fixed;
        min-height: 100svh;
      }
      header {
        position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--ring);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
        backdrop-filter: blur(8px);
      }
      .container { max-width: 1320px; margin: 0 auto; padding: 14px 16px; }
      h1 { margin: 0; font-size: 20px; }
      .grid { display: grid; gap: 14px; }
      .grid-3 { grid-template-columns: 300px 1fr 380px; }
      @media (max-width: 1200px) { .grid-3 { grid-template-columns: 1fr; } }
      .card {
        background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
        border: 1px solid var(--ring); border-radius: 16px; padding: 12px;
      }
      .small { font-size: 12px; color: var(--muted); }
      button {
        cursor: pointer; border: 1px solid #0ea5e9;
        background: linear-gradient(180deg, #1d4ed8, #0ea5e9);
        font-weight: 800; border-radius: 12px; padding: 10px 14px; color: #fff;
      }
      button.ghost { background: var(--panel); border: 1px solid #334155; }
      button.ghost.sel { outline: 2px solid var(--pri); }
      .chip {
        display: inline-flex; gap: 6px; align-items: center;
        background: var(--panel); border: 1px solid #2a3650; border-radius: 999px; padding: 6px 10px;
      }
      .badge {
        display: inline-flex; align-items: center; gap: 6px;
        background: #0b1220; border: 1px solid #344155; border-radius: 10px; padding: 4px 8px;
      }
      .logo-picker { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
      .logo-pick {
        border: 1px solid #2a3650; border-radius: 12px; padding: 6px;
        display: flex; align-items: center; justify-content: center; background: #0b1220;
        cursor: pointer; transition: transform .08s;
      }
      .logo-pick:hover { transform: translateY(-2px); }
      .logo-pick img { width: 38px; height: 38px; }
      .crest { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #2a3650; overflow: hidden; }
      .crest img { width: 100%; height: 100%; object-fit: cover; }
      .team-section { border: 1px solid #2a3650; border-radius: 14px; padding: 10px; background: #0b1220; }
      .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; }
      .p-card { border: 1px solid #223047; border-radius: 14px; padding: 10px; background: #0a1120; }
      .p-head { display: flex; gap: 10px; align-items: center; }
      .avatar { width: 46px; height: 46px; border-radius: 50%; border: 1px solid #334155; overflow: hidden; }
      .avatar img { width: 100%; height: 100%; object-fit: cover; }
      .bars { display: grid; gap: 6px; margin-top: 6px; }
      .bar { height: 8px; background: #0f172a; border: 1px solid #263149; border-radius: 999px; overflow: hidden; }
      .bar > span { display: block; height: 100%; background: linear-gradient(90deg, var(--pri), var(--pri2)); }
      .formation { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
      .slot { min-height: 92px; border: 1px dashed #2b3650; border-radius: 12px; padding: 8px; background: #0b1220; }
      .slot.fill { border: 1px solid #2dd4bf; }
      .slot.wrong { box-shadow: 0 0 0 3px rgba(245,158,11,.25); }
      .sum { font-weight: 800; font-size: 22px; }
      .mask { filter: blur(6px); opacity: .7; user-select: none; }
      .sticky-head {
        position: sticky; top: 68px; z-index: 5;
        background: linear-gradient(180deg, rgba(13,19,36,.95), rgba(13,19,36,.8));
        border: 1px solid #23324b; border-radius: 12px; padding: 8px; margin-bottom: 10px; backdrop-filter: blur(4px);
      }
      .seg { display: inline-flex; background: #0e162b; border: 1px solid #2a395b; border-radius: 10px; overflow: hidden; }
      .seg button { border: none; background: transparent; padding: 8px 12px; }
      .seg button.active { background: #163056; }
      #summaryView {
        position: fixed; inset: 0; background: rgba(0,0,0,.75); backdrop-filter: blur(4px);
        display: none; align-items: center; justify-content: center; padding: 16px;
      }
      .summary-card { max-width: 1100px; width: 100%; background: #0b1220; border: 1px solid #2a3650; border-radius: 16px; padding: 16px; }
      .row2 { display: grid; grid-template-columns: 1fr 220px 1fr; gap: 10px; align-items: center; }
      .diffbar { height: 8px; background: #0f172a; border: 1px solid #263149; border-radius: 999px; overflow: hidden; }
      .diffA { height: 100%; float: right; background: linear-gradient(90deg, #34d399, #22c55e); }
      .diffB { height: 100%; background: linear-gradient(90deg, #ef4444, #f97316); }
      .footer-hint {
        position: sticky; bottom: 0; margin-top: 10px;
        background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.006));
        border: 1px dashed #30415f; border-radius: 12px; padding: 8px;
      }
      .err { color: #fecaca; }
    </style>
  </head>
  <body>
    <header>
      <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h1>⚽ EPL Draft Duel — โหมดสมจริง (FPL รายสัปดาห์)</h1>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="chip">GW ล่าสุด: <b id="labGW" style="margin-left: 6px">—</b></span>
          <span class="chip">อัปเดต: <span id="labUpd" style="margin-left: 6px">—</span></span>
          <span class="badge">A เปลี่ยนทีมข้อมูลเหลือ <b id="quotaA">3</b></span>
          <span class="badge">B เปลี่ยนทีมข้อมูลเหลือ <b id="quotaB">3</b></span>
          <button id="btnReload" class="ghost">รีโหลดข้อมูล</button>
        </div>
      </div>
    </header>

    <main class="container grid grid-3" id="mainView">
      <!-- ซ้าย: โลโก้โชว์ + เลือกฝั่งที่กำลังตั้งตรา -->
      <section class="card">
        <h3 style="margin:0 0 6px">โลโก้พรีเมียร์ลีก (สำหรับโชว์บนกระดาน)</h3>
        <div class="small">เลือกฝั่งที่จะตั้งตรา → คลิกโลโก้ด้านล่าง</div>
        <div style="display:flex;gap:8px;margin:8px 0">
          <button id="btnCrestA" class="ghost sel" onclick="setCrestSide('A')">ตั้งตราให้ทีม A</button>
          <button id="btnCrestB" class="ghost" onclick="setCrestSide('B')">ตั้งตราให้ทีม B</button>
        </div>
        <div id="logoGrid" class="logo-picker" style="margin-top:8px"></div>
        <div class="footer-hint small">
          <div>ตราโชว์ ≠ ทีมข้อมูล (ใช้เพื่อความสวยงามเท่านั้น)</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <span>ตราปัจจุบัน:</span>
            <span class="crest" id="crestA" title="โลโก้ทีม A"></span><span class="small">ทีม A</span>
            <span class="crest" id="crestB" title="โลโก้ทีม B" style="margin-left:10px"></span><span class="small">ทีม B</span>
          </div>
        </div>
      </section>

      <!-- กลาง: เลือกทีมข้อมูล + XI ล่าสุด -->
      <section class="card">
        <div class="sticky-head">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
              <b>ทีมข้อมูลจาก GW ล่าสุด</b>
              <span class="small">คลิกโลโก้ทีมเพื่อแสดง XI ที่ลงสนามจริง</span>
            </div>
            <div class="seg" role="tablist" aria-label="เลือกฝั่งที่จะรับนักเตะ">
              <button id="segA" class="active" onclick="setActiveDataSide('A')">เลือกให้ทีม A</button>
              <button id="segB" onclick="setActiveDataSide('B')">เลือกให้ทีม B</button>
            </div>
          </div>
          <div id="dataLogos" class="logo-picker" style="margin-top:8px"></div>
        </div>

        <div id="teamsPlayers" style="display:grid;gap:12px;max-height:60vh;overflow:auto;margin-top:8px"></div>
        <div class="small" id="progress" style="margin-top:6px">กำลังโหลดข้อมูล…</div>
      </section>

      <!-- ขวา: กระดานทีม A/B -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>ทีม A</b><span>รวมพลัง: <span id="sumA" class="sum mask">ซ่อนอยู่</span></span>
        </div>
        <div class="formation" id="formA"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="ghost" id="btnConfirmA" disabled onclick="confirmTeam('A')">ยืนยันทีม A</button>
        </div>

        <hr style="border-color:#2a3650;opacity:.4;margin:10px 0" />

        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>ทีม B</b><span>รวมพลัง: <span id="sumB" class="sum mask">ซ่อนอยู่</span></span>
        </div>
        <div class="formation" id="formB"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="ghost" id="btnConfirmB" disabled onclick="confirmTeam('B')">ยืนยันทีม B</button>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="btnBattle" disabled onclick="battle()">แข่งขัน</button>
          <button class="ghost" onclick="resetBoards()">ล้างกระดาน</button>
        </div>
        <div id="result" class="small" style="margin-top:8px"></div>
      </section>
    </main>

    <!-- สรุปผลการแข่งขัน -->
    <section id="summaryView">
      <div class="summary-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0">สรุปผลการแข่งขัน (GW <span id="sumGW">—</span>)</h3>
          <div class="small">ปิดเพื่อกลับไปหน้าจัดทีม</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin:8px 0">
          <span class="crest" id="sumCrestA"></span>
          <b id="sumNameA">ทีม A</b>
          <span class="badge">รวม: <b id="sumTotalA">0</b></span>
          <span style="margin:0 8px">VS</span>
          <span class="badge">รวม: <b id="sumTotalB">0</b></span>
          <b id="sumNameB">ทีม B</b>
          <span class="crest" id="sumCrestB"></span>
          <div style="margin-left:auto"><button class="ghost" onclick="closeSummary()">ปิด</button></div>
        </div>
        <div id="sumRows" style="display:grid;gap:6px;margin-top:8px"></div>
      </div>
    </section>

    <div id="status" class="small" style="position:fixed;right:12px;bottom:12px;display:none"></div>

    <script>
      // --- พาธไฟล์ (รองรับทั้ง GitHub Pages และรันโลคัล) ---
      const BASE = (location.hostname.endsWith('github.io'))
        ? location.pathname.replace(/\/[^\/]*$/, '')
        : '.';
      const SNAPSHOT_PATH = `${BASE}/public/data/fpl_current.json`;

      const FORMATION = [
        { id: "GK", expect: "Goalkeeper" },
        { id: "RB", expect: "Defender" },
        { id: "RCB", expect: "Defender" },
        { id: "LCB", expect: "Defender" },
        { id: "LB", expect: "Defender" },
        { id: "CM1", expect: "Midfielder" },
        { id: "CM2", expect: "Midfielder" },
        { id: "CAM", expect: "Midfielder" },
        { id: "RW", expect: "Attacker" },
        { id: "ST", expect: "Attacker" },
        { id: "LW", expect: "Attacker" },
      ];
      const WRONG_POS_PENALTY = 0.7;
      const DATA_SWITCH_LIMIT = 3;

      const state = {
        fpl: { teams: [], playersPlayed: [], playersById: {}, xiByTeam: {}, gw: null, updatedAt: null },
        crestSide: "A",
        dataPickSide: "A",
        dataTeamOf: { A: null, B: null },
        dataSwitchQuota: { A: DATA_SWITCH_LIMIT, B: DATA_SWITCH_LIMIT },
        currentXI: [],
        A: FORMATION.map((x) => ({ ...x, player: null })),
        B: FORMATION.map((x) => ({ ...x, player: null })),
        confirmed: { A: false, B: false },
        crestImg: { A: "", B: "" },
      };

      const statusEl = document.getElementById("status");
      const showStatus = (msg, ms = 2200) => {
        statusEl.style.display = "block";
        statusEl.textContent = msg || "";
        if (ms) setTimeout(() => (statusEl.style.display = "none"), ms);
      };
      const clamp = (v, min = 0, max = 100) => Math.max(min, Math.min(max, +v || 0));

      async function loadSnapshot() {
        try {
          const r = await fetch(SNAPSHOT_PATH + `?t=${Date.now()}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);

          const ct = (r.headers.get('content-type') || '').toLowerCase();
          if (!ct.includes('application/json')) {
            const sample = await r.text();
            throw new Error('ไฟล์ที่ได้ไม่ใช่ JSON (ตัวอย่าง): ' + sample.slice(0, 120));
          }
          const j = await r.json();

          const playersById = {};
          (j.players_played || []).forEach((p) => (playersById[p.id] = p));

          state.fpl.teams = j.teams || [];
          state.fpl.playersPlayed = j.players_played || [];
          state.fpl.playersById = playersById;
          state.fpl.xiByTeam = j.xiByTeam || {};
          state.fpl.gw = j.gw || "-";
          state.fpl.updatedAt = j.generated_at || "-";

          document.getElementById("labGW").textContent = state.fpl.gw;
          document.getElementById("labUpd").textContent =
            state.fpl.updatedAt ? new Date(state.fpl.updatedAt).toLocaleString("th-TH", { hour12: false }) : "—";

          renderLogoGrids();
          document.getElementById("progress").innerHTML =
            'เลือกโลโก้ทีมข้อมูลด้านบนเพื่อดู 11 ตัวล่าสุด <span class="small">(หากว่างเปล่า ให้ตรวจไฟล์ <code>public/data/fpl_current.json</code>)</span>';
        } catch (e) {
          document.getElementById("progress").innerHTML =
            '<span class="err">โหลดไม่ได้:</span> ยังไม่มีไฟล์ data — ไปที่แท็บ <b>Actions</b> แล้วรัน workflow เพื่อสร้างไฟล์';
          console.error(e);
          alert("โหลดข้อมูลไม่สำเร็จ:\n" + e.message);
        }
      }

      function renderLogoGrids() {
        const logos = state.fpl.teams.map((t) => ({ id: t.id, name: t.name, png: t.badge || t.logo || "" }));

        const left = document.getElementById("logoGrid");
        left.innerHTML = "";
        logos.forEach((t) => {
          const d = document.createElement("div");
          d.className = "logo-pick";
          d.title = t.name;
          d.innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          d.onclick = () => {
            const s = state.crestSide;
            document.getElementById(s === "A" ? "crestA" : "crestB").innerHTML = `<img src="${t.png}" alt="${t.name}">`;
            state.crestImg[s] = t.png;
          };
          left.appendChild(d);
        });

        const right = document.getElementById("dataLogos");
        right.innerHTML = "";
        logos.forEach((t) => {
          const d = document.createElement("div");
          d.className = "logo-pick";
          d.title = "ข้อมูล: " + t.name;
          d.innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          d.onclick = () => selectDataTeam(state.dataPickSide, t.id);
          right.appendChild(d);
        });
      }

      function setCrestSide(side) {
        state.crestSide = side;
        document.getElementById('btnCrestA').classList.toggle('sel', side === 'A');
        document.getElementById('btnCrestB').classList.toggle('sel', side === 'B');
        showStatus(`ตั้งตราโชว์ให้ทีม ${side} — คลิกโลโก้ได้เลย`);
      }
      function setActiveDataSide(side) {
        state.dataPickSide = side;
        document.getElementById("segA").classList.toggle("active", side === "A");
        document.getElementById("segB").classList.toggle("active", side === "B");
        showStatus(`กำลังเลือกทีมข้อมูลให้ฝั่ง ${side}`);
      }

      function selectDataTeam(side, teamId) {
        if (state.dataTeamOf[side] !== teamId) {
          if (state.dataSwitchQuota[side] <= 0) {
            showStatus(`ทีม ${side} ใช้โควตาเปลี่ยนทีมข้อมูลครบแล้ว`, 2500);
            return;
          }
          state.dataSwitchQuota[side]--;
          state.dataTeamOf[side] = teamId;
          document.getElementById("quotaA").textContent = state.dataSwitchQuota.A;
          document.getElementById("quotaB").textContent = state.dataSwitchQuota.B;
        }
        renderXI(teamId);
      }

      function renderXI(teamId) {
        const ids = state.fpl.xiByTeam[teamId] || [];
        const players = ids.map((id) => state.fpl.playersById[id]).filter(Boolean);
        state.currentXI = players;

        const teamObj = state.fpl.teams.find((t) => t.id === teamId) || {};
        const teamName = teamObj.name || "—";

        const box = document.getElementById("teamsPlayers");
        box.innerHTML = "";
        const sec = document.createElement("div");
        sec.className = "team-section";
        sec.innerHTML = `
          <div class="team-header" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <div class="crest"><img src="${teamObj.badge || ""}"></div>
            <b>${teamName}</b>
            <span class="small" style="margin-left:auto">11 ตัวล่าสุดที่ลงสนาม (GW ${state.fpl.gw})</span>
          </div>
          <div class="players-grid"></div>`;
        const grid = sec.querySelector(".players-grid");

        players.forEach((p) => {
          const P = p.powers_gw || { ATT: 0, CRE: 0, DEF: 0, FIT: 0, CTRL: 0, TOTAL: 0 };
          const bar = (label, val) =>
            `<div><div class="small" style="display:flex;justify-content:space-between"><span>${label}</span><span>${Math.round(val)}</span></div><div class="bar"><span style="width:${clamp(val)}%"></span></div></div>`;
          const card = document.createElement("div");
          card.className = "p-card";
          card.innerHTML = `
            <div class="p-head">
              <div class="avatar"><img src="${p.photo}" onerror="this.src='https://static.api-football.com/players/players.webp'"></div>
              <div><div style="font-weight:700">${p.name}</div><div class="small">${p.team} • ${p.role}</div></div>
              <div style="margin-left:auto;text-align:right"><div style="font-size:22px;font-weight:800">${P.TOTAL}</div><div class="small">POWER</div></div>
            </div>
            <div class="bars">
              ${bar("ATT", P.ATT)}${bar("CRE", P.CRE)}${bar("DEF", P.DEF)}${bar("FIT", P.FIT)}${bar("CTRL", P.CTRL)}
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="ghost">+ ทีม A</button>
              <button class="ghost">+ ทีม B</button>
            </div>`;
          const btns = card.querySelectorAll("button");
          btns[0].onclick = () => quickAdd("A", p);
          btns[1].onclick = () => quickAdd("B", p);
          grid.appendChild(card);
        });

        box.appendChild(sec);
        document.getElementById("progress").textContent = `แสดงผู้เล่นของ ${teamName}`;
      }

      const isRoleMatch = (expect, role) =>
        (expect === "Goalkeeper" && role === "Goalkeeper") ||
        (expect === "Defender" && role === "Defender") ||
        (expect === "Midfielder" && role === "Midfielder") ||
        (expect === "Attacker" && role === "Attacker");

      function applyPenalty(player, isWrong) {
        const f = isWrong ? WRONG_POS_PENALTY : 1;
        const P = player.powers_gw || { ATT: 0, CRE: 0, DEF: 0, FIT: 0, CTRL: 0 };
        return Math.round((P.ATT*f + P.CRE*f + P.DEF*f + P.FIT*f + P.CTRL*f) / 5);
        }

      function renderBoard(side, rootId) {
        const team = side === "A" ? state.A : state.B;
        const root = document.getElementById(rootId);
        root.innerHTML = "";
        team.forEach((slot, idx) => {
          const has = !!slot.player;
          const wrong = has && !isRoleMatch(slot.expect, slot.player.role);
          const d = document.createElement("div");
          d.className = `slot ${has ? "fill" : ""} ${wrong ? "wrong" : ""}`;
          d.innerHTML = `<div class="small" style="opacity:.8">${slot.id} (${slot.expect})</div>
            ${
              has
                ? `<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                    <div class="avatar" style="width:38px;height:38px"><img src="${slot.player.photo}"></div>
                    <div>
                      <div style="font-weight:700">${slot.player.name}</div>
                      <div class="small">${slot.player.role}${wrong ? ' • <span style="color:#fecaca">ผิดตำแหน่ง</span>' : ""}</div>
                      <div class="small">Power: ${slot.player.adjTotal}</div>
                    </div>
                  </div>`
                : `<div class="small" style="opacity:.7">กด + จากรายการตรงกลางเพื่อเพิ่ม</div>`
            }`;
          root.appendChild(d);
        });
        refreshSums();
        document.getElementById(side === "A" ? "btnConfirmA" : "btnConfirmB").disabled =
          !team.every((x) => !!x.player);
        document.getElementById("btnBattle").disabled = !(state.confirmed.A && state.confirmed.B);
      }

      function place(side, idx, player) {
        if (state.confirmed[side]) { showStatus(`ทีม ${side} ถูกล็อกแล้ว`); return; }
        const duplicated = [...state.A, ...state.B].some((s) => s.player && s.player.id === player.id);
        if (duplicated) { showStatus("ผู้เล่นคนนี้ถูกเลือกไปแล้ว"); return; }

        const team = side === "A" ? state.A : state.B;
        if (team[idx].player) { showStatus("ช่องนี้มีผู้เล่นแล้ว"); return; }

        const wrong = !isRoleMatch(team[idx].expect, player.role);
        const adj = applyPenalty(player, wrong);
        team[idx].player = { ...player, adjTotal: adj, wrong };
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }

      function quickAdd(side, player) {
        if (state.confirmed[side]) { showStatus(`ทีม ${side} ถูกล็อกแล้ว`); return; }
        const duplicated = [...state.A, ...state.B].some((s) => s.player && s.player.id === player.id);
        if (duplicated) { showStatus("ผู้เล่นคนนี้ถูกเลือกไปแล้ว"); return; }

        const team = side === "A" ? state.A : state.B;
        let idx = team.findIndex((s) => !s.player && isRoleMatch(s.expect, player.role));
        if (idx < 0) idx = team.findIndex((s) => !s.player);
        if (idx < 0) { showStatus(`ทีม ${side} ครบ 11 แล้ว`); return; }
        place(side, idx, player);
      }

      function refreshSums() {
        const sumA = state.A.reduce((s, x) => s + (x.player ? x.player.adjTotal : 0), 0);
        const sumB = state.B.reduce((s, x) => s + (x.player ? x.player.adjTotal : 0), 0);
        const elA = document.getElementById("sumA");
        const elB = document.getElementById("sumB");
        const unlocked = state.confirmed.A && state.confirmed.B;
        elA.textContent = unlocked ? sumA : "ซ่อนอยู่";
        elB.textContent = unlocked ? sumB : "ซ่อนอยู่";
        elA.classList.toggle("mask", !unlocked);
        elB.classList.toggle("mask", !unlocked);
      }

      function confirmTeam(side) {
        const team = side === "A" ? state.A : state.B;
        if (!team.every((x) => !!x.player)) { showStatus(`ทีม ${side} ยังไม่ครบ 11`); return; }
        state.confirmed[side] = true;
        showStatus(`ล็อกทีม ${side} แล้ว`);
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }

      function resetBoards() {
        if (state.confirmed.A || state.confirmed.B) {
          if (!confirm("รีเซ็ตทั้งหมดและปลดล็อกทีม?")) return;
        }
        state.A = FORMATION.map((x) => ({ ...x, player: null }));
        state.B = FORMATION.map((x) => ({ ...x, player: null }));
        state.confirmed = { A: false, B: false };
        state.dataSwitchQuota = { A: DATA_SWITCH_LIMIT, B: DATA_SWITCH_LIMIT };
        state.dataTeamOf = { A: null, B: null };
        document.getElementById("quotaA").textContent = state.dataSwitchQuota.A;
        document.getElementById("quotaB").textContent = state.dataSwitchQuota.B;
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        refreshSums();
        document.getElementById("btnBattle").disabled = true;
      }

      function battle() {
        const cntA = state.A.filter((s) => s.player).length, cntB = state.B.filter((s) => s.player).length;
        if (cntA < 11 || cntB < 11) { alert("ต้องครบ 11 คนทั้งสองทีม"); return; }
        if (!(state.confirmed.A && state.confirmed.B)) { alert("ต้องกดยืนยันทั้งสองทีมก่อน"); return; }

        const totalA = state.A.reduce((s, x) => s + x.player.adjTotal, 0);
        const totalB = state.B.reduce((s, x) => s + x.player.adjTotal, 0);
        document.getElementById("result").textContent =
          totalA > totalB ? `ทีม A ชนะ ${totalA} ต่อ ${totalB}`
          : totalB > totalA ? `ทีม B ชนะ ${totalB} ต่อ ${totalA}`
          : `เสมอ ${totalA} ต่อ ${totalB}`;
        openSummary(totalA, totalB);
      }

      function openSummary(totalA, totalB) {
        document.getElementById("sumGW").textContent = state.fpl.gw || "-";
        document.getElementById("sumTotalA").textContent = totalA;
        document.getElementById("sumTotalB").textContent = totalB;
        document.getElementById("sumCrestA").innerHTML = state.crestImg.A ? `<img src="${state.crestImg.A}">` : "";
        document.getElementById("sumCrestB").innerHTML = state.crestImg.B ? `<img src="${state.crestImg.B}">` : "";

        const rows = document.getElementById("sumRows");
        rows.innerHTML = "";
        for (let i = 0; i < FORMATION.length; i++) {
          const a = state.A[i].player, b = state.B[i].player;
          const av = a ? a.adjTotal : 0, bv = b ? b.adjTotal : 0;
          const diff = av - bv, abs = Math.min(100, Math.abs(diff));
          const row = document.createElement("div");
          row.className = "row2";
          row.innerHTML = `
            <div style="display:flex;gap:8px;align-items:center">
              <div class="avatar" style="width:40px;height:40px">${a ? `<img src="${a.photo}">` : ""}</div>
              <div>
                <div style="font-weight:700">${a ? a.name : "—"}</div>
                <div class="small">${FORMATION[i].id} (${FORMATION[i].expect}) • ${a ? a.role : "-"}</div>
                <div class="small">Power: ${av}</div>
              </div>
            </div>
            <div>
              <div class="small" style="text-align:center;margin-bottom:4px">ต่างกัน ${diff > 0 ? `+${diff}` : diff} แต้ม</div>
              <div class="diffbar">${diff >= 0
                ? `<div class="diffA" style="width:${abs}%"></div>`
                : `<div class="diffB" style="width:${abs}%"></div>`}
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
              <div>
                <div style="font-weight:700;text-align:right">${b ? b.name : "—"}</div>
                <div class="small" style="text-align:right">${FORMATION[i].id} (${FORMATION[i].expect}) • ${b ? b.role : "-"}</div>
                <div class="small" style="text-align:right">Power: ${bv}</div>
              </div>
              <div class="avatar" style="width:40px;height:40px">${b ? `<img src="${b.photo}">` : ""}</div>
            </div>`;
          rows.appendChild(row);
        }
        document.getElementById("summaryView").style.display = "flex";
      }
      const closeSummary = () => (document.getElementById("summaryView").style.display = "none");

      document.getElementById("btnReload").onclick = loadSnapshot;

      (function init() {
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        setActiveDataSide("A");
        setCrestSide("A");
        loadSnapshot();
      })();
    </script>
  </body>
</html>

