<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      EPL Draft Duel — เลือกตราก่อน แล้วค่อยดึง XI (API-FOOTBALL) +
      หน้าสรุปตำแหน่ง
    </title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0a0f1f;
        --ring: #223047;
        --muted: #9aa4b2;
        --pri: #22d3ee;
        --pri2: #818cf8;
        --ok: #34d399;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        color: #e5e7eb;
        font-family: "Kanit", system-ui, Roboto;
        background: radial-gradient(
            1000px 700px at 15% -10%,
            #1f2937 0%,
            #0f172a 50%,
            #0a0f1f 100%
          )
          fixed;
        min-height: 100svh;
      }
      header {
        position: sticky;
        top: 0;
        padding: 14px 16px;
        border-bottom: 1px solid var(--ring);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0)
        );
        backdrop-filter: blur(6px);
        z-index: 5;
      }
      .container {
        max-width: 1320px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      .grid {
        display: grid;
        gap: 14px;
      }
      .grid-3 {
        grid-template-columns: 1fr 1.3fr 1fr;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid var(--ring);
        border-radius: 14px;
        padding: 12px;
      }
      button {
        cursor: pointer;
        border: 1px solid #0ea5e9;
        background: linear-gradient(180deg, #1d4ed8, #0ea5e9);
        font-weight: 800;
        border-radius: 10px;
        padding: 10px 12px;
      }
      button.ghost {
        background: #0b1220;
        border: 1px solid #334155;
      }
      .small {
        font-size: 12px;
        color: #9aa4b2;
      }
      .logo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
      }
      .logo-item {
        border: 1px solid #2a3650;
        border-radius: 12px;
        padding: 8px;
        background: #0b1220;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .logo-item img {
        width: 46px;
        height: 46px;
      }
      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
      }
      .p-card {
        border: 1px solid #223047;
        border-radius: 14px;
        padding: 10px;
        background: #0a1120;
      }
      .p-head {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 1px solid #334155;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .bars {
        display: grid;
        gap: 6px;
      }
      .bar {
        height: 8px;
        background: #0f172a;
        border: 1px solid #263149;
        border-radius: 999px;
        overflow: hidden;
      }
      .bar > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--pri), var(--pri2));
      }
      .team-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .crest {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #2a3650;
        overflow: hidden;
      }
      .crest img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .formation {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .slot {
        min-height: 96px;
        border: 1px dashed #2b3650;
        border-radius: 12px;
        padding: 8px;
        background: #0b1220;
      }
      .slot.fill {
        border: 1px solid #2dd4bf;
      }
      .slot.wrong {
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
      }
      .sum {
        font-weight: 800;
        font-size: 22px;
      }
      .tag {
        font-size: 10px;
        border: 1px solid #334155;
        border-radius: 999px;
        padding: 2px 6px;
        margin-left: 6px;
        opacity: 0.85;
      }
      .disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      /* ===== Summary Screen ===== */
      #summaryScreen {
        display: none;
      }
      .sum-wrap {
        max-width: 1100px;
        margin: 24px auto;
      }
      .sum-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 14px;
      }
      .sum-meta {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .sum-crest {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid #334155;
        overflow: hidden;
      }
      .sum-crest img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .vs {
        font-weight: 800;
        font-size: 18px;
        color: #94a3b8;
      }
      .sum-total {
        font-size: 26px;
        font-weight: 800;
      }
      .sum-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 12px;
      }
      .sum-card {
        border: 1px solid #223047;
        border-radius: 14px;
        padding: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
      }
      .pos-title {
        font-weight: 800;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
      }
      .chip {
        font-size: 11px;
        border: 1px solid #334155;
        border-radius: 999px;
        padding: 2px 6px;
      }
      .diff-wrap {
        margin-top: 6px;
      }
      .diff-bar {
        height: 8px;
        border: 1px solid #263149;
        border-radius: 999px;
        overflow: hidden;
        background: #0f172a;
      }
      .diff-fill {
        height: 100%;
        display: block;
      }
      .winA {
        background: linear-gradient(90deg, #34d399, #22c55e);
      }
      .winB {
        background: linear-gradient(90deg, #ef4444, #f97316);
      }
      .equal {
        background: linear-gradient(90deg, #22d3ee, #818cf8);
      }
      .sum-cta {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 16px;
      }
      @media (max-width: 1100px) {
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="container"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <h1>⚽ EPL Draft Duel — เลือกตราก่อน แล้วค่อยดึง XI</h1>
        <div
          style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap"
        >
          <label class="small"
            >Season:
            <select id="seasonSel">
              <option value="2024" selected>2024/25</option>
              <option value="2023">2023/24</option>
            </select>
          </label>
          <span class="small"
            >ทีมข้อมูลต่อฝั่ง (สูงสุด 3): A <span id="dataA">0</span>/3 • B
            <span id="dataB">0</span>/3</span
          >
        </div>
      </div>
    </header>

    <!-- ====== GAME SCREEN ====== -->
    <main id="gameScreen" class="container grid grid-3">
      <!-- ซ้าย: โลโก้ EPL + โหมด -->
      <section class="card">
        <h3 style="margin: 0 0 6px">โลโก้พรีเมียร์ลีก</h3>
        <div class="small" style="margin-bottom: 6px">
          1) โหมด “เลือกตรา A/B” เพื่อเลือกตราของผู้เล่น<br />
          2) จากนั้นโหมด “ทีมข้อมูล A/B” เพื่อคลิกโลโก้และดึง XI (ฝั่งละไม่เกิน
          3 ทีม)
        </div>
        <div
          style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px"
        >
          <button class="ghost" id="modeCrestA">โหมด: เลือกตรา A</button>
          <button class="ghost" id="modeCrestB">โหมด: เลือกตรา B</button>
          <button class="ghost" id="modeDataA">โหมด: ทีมข้อมูล A</button>
          <button class="ghost" id="modeDataB">โหมด: ทีมข้อมูล B</button>
        </div>
        <div id="logoGrid" class="logo-grid"></div>
      </section>

      <!-- กลาง: XI ของทีมข้อมูลล่าสุด -->
      <section class="card">
        <h3 style="margin: 0 0 6px">นักเตะทีมข้อมูลล่าสุด — 11 คน</h3>
        <div
          id="teamNow"
          class="small"
          style="margin: 4px 0 10px; opacity: 0.9"
        ></div>
        <div id="playersBox" class="players-grid"></div>
        <div class="small" id="progress" style="margin-top: 6px"></div>
      </section>

      <!-- ขวา: กระดาน 2 ฝั่ง + ยืนยัน + ไปสรุป -->
      <section class="card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div><b>ทีม A</b><span id="tagA" class="tag">ยังไม่ยืนยัน</span></div>
          <span>รวมพลัง: <span id="sumA" class="sum">— (ซ่อน)</span></span>
        </div>
        <div class="formation" id="formA"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button class="ghost" id="btnCrestA">เลือกตราทีม A</button>
          <span id="crestA" class="crest" title="โลโก้ทีม A"></span>
          <button id="confirmA">✅ ยืนยันทีม A</button>
        </div>

        <hr style="border-color: #2a3650; opacity: 0.4" />

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div><b>ทีม B</b><span id="tagB" class="tag">ยังไม่ยืนยัน</span></div>
          <span>รวมพลัง: <span id="sumB" class="sum">— (ซ่อน)</span></span>
        </div>
        <div class="formation" id="formB"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button class="ghost" id="btnCrestB">เลือกตราทีม B</button>
          <span id="crestB" class="crest" title="โลโก้ทีม B"></span>
          <button id="confirmB">✅ ยืนยันทีม B</button>
        </div>

        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
          "
        >
          <button id="battleBtn" class="disabled">
            แข่งขัน (ต้องยืนยันทั้งสองทีม)
          </button>
          <button id="summaryBtn" class="ghost disabled">
            ดูสรุปตำแหน่ง ▶
          </button>
          <button class="ghost" id="resetBtn">เริ่มใหม่</button>
        </div>
        <div id="result" class="small" style="margin-top: 8px"></div>
      </section>
    </main>

    <!-- ====== SUMMARY SCREEN ====== -->
    <section id="summaryScreen" class="sum-wrap">
      <div class="card">
        <div class="sum-head">
          <div class="sum-meta">
            <div class="sum-crest" id="sCrestA"></div>
            <div>
              <div style="font-weight: 800">ทีม A</div>
              <div id="sTeamA" class="small" style="opacity: 0.85"></div>
            </div>
          </div>

          <div class="vs">VS</div>

          <div class="sum-meta" style="text-align: right">
            <div>
              <div style="font-weight: 800">ทีม B</div>
              <div id="sTeamB" class="small" style="opacity: 0.85"></div>
            </div>
            <div class="sum-crest" id="sCrestB"></div>
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <div class="sum-total">รวม A: <span id="sTotA">—</span></div>
          <div class="sum-total">รวม B: <span id="sTotB">—</span></div>
        </div>

        <div id="sumGrid" class="sum-grid"></div>

        <div class="sum-cta">
          <button id="backBtn">⬅ กลับไปกระดาน</button>
          <button id="playAgainBtn" class="ghost">เริ่มใหม่</button>
        </div>
      </div>
    </section>

    <div
      id="status"
      class="small"
      style="position: fixed; right: 12px; bottom: 12px; display: none"
    ></div>

    <script>
      /* =====================[ CONFIG ]===================== */
      // ⚠️ ใส่คีย์ RapidAPI ของคุณตรงนี้ — อย่าแชร์คีย์นี้ใน repo สาธารณะ
      // ตัวอย่าง: const RAPID_API_KEY = "29d9ba18bfmshd94e9259bed4e21p1b054fjsne176c557d97a";
      const RAPID_API_KEY =
        "7d730ef077mshfe6aa2d8089d6a2p1fd664jsne03b58a59c1f"; // <-- ใส่คีย์ตรงนี้
      const API_HOST = "api-football-v1.p.rapidapi.com";
      const LEAGUE_ID = 39; // Premier League
      const MAX_PAGES_PER_TEAM = 1; // ประหยัดโควต้า: 1 หน้า/ทีม (ตั้ง 0 = ดึงครบทุกหน้า)
      const DATA_LIMIT_PER_SIDE = 3; // จำกัด “ทีมข้อมูล” ต่อฝั่ง 3 ทีม
      const CACHE_TTL_MS = 6 * 60 * 60 * 1000;

      /* =====================[ State ]===================== */
      const WRONG_POS_PENALTY = 0.7;
      const FORMATION = [
        { id: "GK", expect: "Goalkeeper" },
        { id: "RB", expect: "Defender" },
        { id: "RCB", expect: "Defender" },
        { id: "LCB", expect: "Defender" },
        { id: "LB", expect: "Defender" },
        { id: "CM1", expect: "Midfielder" },
        { id: "CM2", expect: "Midfielder" },
        { id: "CAM", expect: "Midfielder" },
        { id: "RW", expect: "Attacker" },
        { id: "ST", expect: "Attacker" },
        { id: "LW", expect: "Attacker" },
      ];
      const state = {
        season: "2024",
        teams: [],
        mode: null, // 'crestA'|'crestB'|'dataA'|'dataB'
        crest: { A: null, B: null }, // {id,name,logo}
        dataTeams: { A: new Set(), B: new Set() },
        locked: { A: false, B: false },
        A: FORMATION.map((x) => ({ ...x, player: null })),
        B: FORMATION.map((x) => ({ ...x, player: null })),
        XI_CACHE_MEM: new Map(),
        pending: new Map(),
        lastMatchup: null, // เก็บผลเทียบตำแหน่งหลังแข่ง
      };

      /* =====================[ UI helpers ]===================== */
      const byId = (id) => document.getElementById(id);
      const statusEl = byId("status");
      const gameScreen = byId("gameScreen");
      const summaryScreen = byId("summaryScreen");

      const showStatus = (msg) => {
        statusEl.style.display = "block";
        statusEl.textContent = msg || "";
      };
      function setMode(m) {
        state.mode = m;
        showStatus(`โหมด: ${m}`);
        setTimeout(() => (statusEl.style.display = "none"), 1200);
      }
      function updateDataCounters() {
        byId("dataA").textContent = state.dataTeams.A.size;
        byId("dataB").textContent = state.dataTeams.B.size;
      }
      function teamCount(side) {
        return (side === "A" ? state.A : state.B).filter((x) => x.player)
          .length;
      }
      function canConfirm(side) {
        return teamCount(side) === 11 && !state.locked[side];
      }
      function updateConfirmButtons() {
        byId("confirmA").classList.toggle("disabled", !canConfirm("A"));
        byId("confirmB").classList.toggle("disabled", !canConfirm("B"));
      }
      function updateBattleButton() {
        const ready = state.locked.A && state.locked.B;
        byId("battleBtn").classList.toggle("disabled", !ready);
      }

      /* =====================[ Fetch helpers (rate limit safe) ]===================== */
      async function wait(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }
      function parseResetMs(res) {
        const ra = res.headers.get("Retry-After");
        if (ra && !isNaN(ra)) return parseInt(ra, 10) * 1000;
        const cand = [
          "x-ratelimit-reset",
          "x-ratelimit-requests-reset",
          "X-RateLimit-Reset",
        ];
        for (const k of cand) {
          const v = res.headers.get(k);
          if (!v) continue;
          const n = parseInt(v, 10);
          if (isNaN(n)) continue;
          if (n > 1e10) return Math.max(0, n - Date.now());
          if (n > 1e6)
            return Math.max(0, (n - Math.floor(Date.now() / 1000)) * 1000);
          return n * 1000;
        }
        return null;
      }
      async function fetchWithBackoff(
        url,
        opt = {},
        { tries = 6, baseDelay = 800 } = {}
      ) {
        let delay = baseDelay;
        for (let i = 0; i < tries; i++) {
          const res = await fetch(url, opt);
          if (res.status !== 429) return res;
          const resetMs = parseResetMs(res);
          await wait(resetMs ?? delay);
          delay = Math.min(delay * 2, 10_000);
        }
        throw new Error("429: โดนจำกัดหลายครั้งติดกัน");
      }
      function headers() {
        if (!RAPID_API_KEY || RAPID_API_KEY === "YOUR_RAPID_API_KEY")
          alert("ยังไม่ได้ใส่ RAPID_API_KEY (ดูส่วน CONFIG)");
        return { "X-RapidAPI-Key": RAPID_API_KEY, "X-RapidAPI-Host": API_HOST };
      }

      /* =====================[ API ]===================== */
      async function getTeams(season) {
        const url = `https://${API_HOST}/v3/teams?league=${LEAGUE_ID}&season=${season}`;
        const r = await fetchWithBackoff(url, { headers: headers() });
        if (!r.ok) throw new Error("โหลดรายชื่อทีมไม่สำเร็จ");
        const j = await r.json();
        return j.response.map((x) => ({
          id: x.team.id,
          name: x.team.name,
          logo: x.team.logo,
        }));
      }
      async function getPlayersByTeam(teamId, season) {
        let page = 1,
          total = 1,
          out = [];
        while (page <= total) {
          const url = `https://${API_HOST}/v3/players?team=${teamId}&season=${season}&page=${page}`;
          const r = await fetchWithBackoff(url, { headers: headers() });
          if (!r.ok)
            throw new Error(`โหลดนักเตะทีม ${teamId} หน้า ${page} ไม่สำเร็จ`);
          const j = await r.json();
          out.push(...j.response);
          total = j.paging?.total || 1;
          page++;
          if (MAX_PAGES_PER_TEAM > 0 && page > MAX_PAGES_PER_TEAM) break;
          await wait(250);
        }
        return out
          .map((x) => {
            const s = (x.statistics || []).find(
              (s) => s.league?.id === LEAGUE_ID
            );
            return s ? { player: x.player, stats: s } : null;
          })
          .filter(Boolean);
      }

      /* =====================[ พลังจากสถิติ ]===================== */
      const clamp = (v, min = 0, max = 100) =>
        Math.max(min, Math.min(max, +v || 0));
      const per90 = (v, mins) => ((+v || 0) * 90) / Math.max(1, +mins || 0);
      function mapRole(pos) {
        if (!pos) return "Attacker";
        const P = String(pos).toLowerCase();
        if (P.startsWith("g")) return "Goalkeeper";
        if (P.startsWith("d")) return "Defender";
        if (P.startsWith("m")) return "Midfielder";
        return "Attacker";
      }
      function powerFromStats(s) {
        const m = s.games?.minutes || 0;
        const g90 = per90(s.goals?.total, m);
        const a90 = per90(s.goals?.assists, m);
        const sh90 = per90(s.shots?.total, m);
        const tk90 = per90(s.tackles?.total, m);
        const duelRate = s.duels?.total
          ? (100 * (s.duels?.won || 0)) / (s.duels.total || 1)
          : 0;
        const passAcc = +s.passes?.accuracy || 0;
        const cards = (s.cards?.yellow || 0) * 2 + (s.cards?.red || 0) * 8;

        const ATT = clamp(g90 * 60 + a90 * 25 + sh90 * 5);
        const CRE = clamp(passAcc * 0.6 + a90 * 30);
        const DEF = clamp(tk90 * 15 + duelRate * 0.4 + (s.interceptions || 0));
        const FIT = clamp(Math.min(1, m / (38 * 90)) * 100);
        const CTRL = clamp(90 - cards);
        return {
          ATT,
          CRE,
          DEF,
          FIT,
          CTRL,
          TOTAL: Math.round((ATT + CRE + DEF + FIT + CTRL) / 5),
        };
      }
      function pickTopXI(players) {
        const byPos = (want) =>
          players
            .filter((p) => mapRole(p.stats.games?.position) === want)
            .sort(
              (a, b) =>
                (b.stats.games?.minutes || 0) - (a.stats.games?.minutes || 0)
            );
        const gk = byPos("Goalkeeper").slice(0, 1);
        const df = byPos("Defender").slice(0, 4);
        const mf = byPos("Midfielder").slice(0, 3);
        const fw = byPos("Attacker").slice(0, 3);
        let xi = [...gk, ...df, ...mf, ...fw];
        if (xi.length < 11) {
          const rest = players
            .filter((p) => !xi.includes(p))
            .sort(
              (a, b) =>
                (b.stats.games?.minutes || 0) - (a.stats.games?.minutes || 0)
            );
          xi = xi.concat(rest.slice(0, 11 - xi.length));
        }
        return xi.map((p) => ({
          id: p.player.id,
          name: `${p.player.firstname || ""} ${
            p.player.lastname || p.player.name || ""
          }`.trim(),
          photo:
            p.player.photo ||
            `https://static.api-football.com/players/players.webp`,
          role: mapRole(p.stats.games?.position),
          teamName: p.stats.team?.name || "",
          teamId: p.stats.team?.id,
          minutes: p.stats.games?.minutes || 0,
          powers: powerFromStats(p.stats),
        }));
      }

      /* =====================[ Cache ต่อทีม ]===================== */
      function cacheKey(teamId, season) {
        return `af_xi_${teamId}_${season}`;
      }
      function getCache(teamId, season) {
        if (state.XI_CACHE_MEM.has(teamId))
          return state.XI_CACHE_MEM.get(teamId);
        const raw = localStorage.getItem(cacheKey(teamId, season));
        if (!raw) return null;
        try {
          const j = JSON.parse(raw);
          if (Date.now() - j.t > CACHE_TTL_MS) return null;
          return j.data;
        } catch {
          return null;
        }
      }
      function setCache(teamId, season, data) {
        state.XI_CACHE_MEM.set(teamId, data);
        localStorage.setItem(
          cacheKey(teamId, season),
          JSON.stringify({ t: Date.now(), data })
        );
      }

      /* =====================[ Renderers ]===================== */
      function bar(label, val) {
        val = Math.round(val);
        let color = "linear-gradient(90deg,#22d3ee,#818cf8)";
        if (val >= 80) color = "linear-gradient(90deg,#34d399,#22c55e)";
        else if (val < 40) color = "linear-gradient(90deg,#ef4444,#f97316)";
        return `<div><div class="small" style="display:flex;justify-content:space-between"><span>${label}</span><span>${val}</span></div><div class="bar"><span style="width:${val}%;background:${color}"></span></div></div>`;
      }
      function renderLogoGrid(teams) {
        const g = byId("logoGrid");
        g.innerHTML = "";
        teams
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((t) => {
            const d = document.createElement("div");
            d.className = "logo-item";
            d.innerHTML = `<img src="${t.logo}" alt="${t.name}"><div class="small" style="text-align:center">${t.name}</div>`;
            d.onclick = () => onLogoClick(t);
            g.appendChild(d);
          });
      }
      function renderXI(team, xi) {
        const box = byId("playersBox");
        const head = byId("teamNow");
        box.innerHTML = "";
        head.innerHTML = `<b>${team.name}</b> — 11 คน (season ${state.season})`;

        xi.forEach((p) => {
          const card = document.createElement("div");
          card.className = "p-card";
          const btnA_dis = state.locked.A ? "disabled" : "";
          const btnB_dis = state.locked.B ? "disabled" : "";
          card.innerHTML = `
      <div class="p-head">
        <div class="avatar"><img src="${
          p.photo
        }" onerror="this.src='https://static.api-football.com/players/players.webp'"></div>
        <div><div style="font-weight:700">${p.name}</div><div class="small">${
            team.name
          } • ${p.role}</div></div>
        <div style="margin-left:auto;text-align:right"><div style="font-size:22px;font-weight:800">${
          p.powers.TOTAL
        }</div><div class="small">POWER</div></div>
      </div>
      <div class="bars" style="margin-top:6px">
        ${bar("ATT", p.powers.ATT)}${bar("CRE", p.powers.CRE)}${bar(
            "DEF",
            p.powers.DEF
          )}${bar("FIT", p.powers.FIT)}${bar("CTRL", p.powers.CTRL)}
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="ghost ${btnA_dis}">+ ทีม A</button>
        <button class="ghost ${btnB_dis}">+ ทีม B</button>
      </div>`;
          card.querySelectorAll("button")[0].onclick = () =>
            !state.locked.A && quickAdd("A", p);
          card.querySelectorAll("button")[1].onclick = () =>
            !state.locked.B && quickAdd("B", p);
          box.appendChild(card);
        });
      }
      function renderBoard(side, rootId) {
        const team = side === "A" ? state.A : state.B;
        const root = byId(rootId);
        root.innerHTML = "";
        team.forEach((slot) => {
          const has = !!slot.player;
          const wrong = has && slot.player.role !== slot.expect;
          const d = document.createElement("div");
          d.className = `slot ${has ? "fill" : ""} ${wrong ? "wrong" : ""}`;
          d.innerHTML = `<div class="small" style="opacity:.8">${slot.id} (${
            slot.expect
          })</div>
      ${
        has
          ? `
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div class="avatar" style="width:38px;height:38px"><img src="${
            slot.player.photo
          }"></div>
          <div>
            <div style="font-weight:700">${slot.player.name}</div>
            <div class="small">${slot.player.role}${
              wrong ? ' • <span style="color:#fecaca">ผิดตำแหน่ง</span>' : ""
            }</div>
            <div class="small">Power: ${slot.player.adjTotal}</div>
          </div>
        </div>`
          : `<div class="small" style="opacity:.7">กด + จากการ์ดผู้เล่นด้านซ้าย</div>`
      }`;
          root.appendChild(d);
        });
        updateSumsMasked();
        updateConfirmButtons();
      }

      /* =====================[ Logic: place / sums / battle / summary ]===================== */
      function applyPenalty(player, isWrong) {
        const f = isWrong ? WRONG_POS_PENALTY : 1;
        const P = player.powers;
        return Math.round(
          (P.ATT * f + P.CRE * f + P.DEF * f + P.FIT * f + P.CTRL * f) / 5
        );
      }
      function quickAdd(side, player) {
        if (state.locked[side]) return;
        const team = side === "A" ? state.A : state.B;
        if (team.some((s) => s.player && s.player.id === player.id))
          return alert("ผู้เล่นนี้อยู่ในทีมแล้ว");
        let idx = team.findIndex((s) => !s.player && s.expect === player.role);
        if (idx < 0) idx = team.findIndex((s) => !s.player);
        if (idx < 0) return alert(`ทีม ${side} ครบ 11 แล้ว`);
        const wrong = team[idx].expect !== player.role;
        team[idx].player = {
          ...player,
          adjTotal: applyPenalty(player, wrong),
          wrong,
        };
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }
      function sumTeam(side) {
        const team = side === "A" ? state.A : state.B;
        return team.reduce((s, x) => s + (x.player ? x.player.adjTotal : 0), 0);
      }
      function updateSumsMasked() {
        const aFull = teamCount("A") === 11,
          bFull = teamCount("B") === 11;
        byId("sumA").textContent = aFull ? "— (ซ่อน)" : "กำลังจัดตัว";
        byId("sumB").textContent = bFull ? "— (ซ่อน)" : "กำลังจัดตัว";
      }
      function computeMatchup() {
        // จับคู่ตามดัชนีของ FORMATION (GK ↔ GK, RB ↔ RB, ...)
        const rows = FORMATION.map((slot, i) => {
          const A = state.A[i].player,
            B = state.B[i].player;
          const aPow = A ? A.adjTotal : 0,
            bPow = B ? B.adjTotal : 0;
          const diff = aPow - bPow;
          const win = diff > 0 ? "A" : diff < 0 ? "B" : "=";
          return {
            pos: slot.id,
            expect: slot.expect,
            A: A
              ? { name: A.name, power: aPow, role: A.role, photo: A.photo }
              : { name: "—", power: 0, role: slot.expect, photo: "" },
            B: B
              ? { name: B.name, power: bPow, role: B.role, photo: B.photo }
              : { name: "—", power: 0, role: slot.expect, photo: "" },
            diff,
            win,
          };
        });
        const totA = sumTeam("A"),
          totB = sumTeam("B");
        return { rows, totA, totB };
      }
      function battle() {
        if (!state.locked.A || !state.locked.B) return;
        const a = sumTeam("A"),
          b = sumTeam("B");
        byId("result").textContent =
          a > b
            ? `ทีม A ชนะ ${a} ต่อ ${b}`
            : b > a
            ? `ทีม B ชนะ ${b} ต่อ ${a}`
            : `เสมอ ${a} ต่อ ${b}`;
        // บันทึก match-up สำหรับหน้า Summary
        state.lastMatchup = computeMatchup();
        // เปิดปุ่มดูสรุปตำแหน่ง
        byId("summaryBtn").classList.remove("disabled");
      }
      function goSummary() {
        if (!state.lastMatchup) return;
        // เติมหัวสรุป
        byId("sCrestA").innerHTML = state.crest.A
          ? `<img src="${state.crest.A.logo}">`
          : "";
        byId("sCrestB").innerHTML = state.crest.B
          ? `<img src="${state.crest.B.logo}">`
          : "";
        byId("sTeamA").textContent = state.crest.A?.name || "";
        byId("sTeamB").textContent = state.crest.B?.name || "";

        // ผลรวม (ตอนนี้สามารถโชว์ได้แล้วหลังแข่ง)
        byId("sTotA").textContent = state.lastMatchup.totA;
        byId("sTotB").textContent = state.lastMatchup.totB;

        // สร้างการ์ดเทียบตำแหน่ง
        const grid = byId("sumGrid");
        grid.innerHTML = "";
        state.lastMatchup.rows.forEach((row) => {
          const diffAbs = Math.abs(row.diff);
          const winner = row.win; // 'A' | 'B' | '='
          const fillW = Math.min(100, diffAbs); // แปลงเป็น %
          const cls =
            winner === "A" ? "winA" : winner === "B" ? "winB" : "equal";
          const label = winner === "=" ? `เท่ากัน` : `ต่างกัน ${diffAbs}`;
          const card = document.createElement("div");
          card.className = "sum-card";
          card.innerHTML = `
      <div class="pos-title">${row.pos} <span class="chip">${
            row.expect
          }</span></div>
      <div class="row">
        <div class="avatar" style="width:34px;height:34px"><img src="${
          row.A.photo || "https://static.api-football.com/players/players.webp"
        }"></div>
        <div style="flex:1">
          <div style="font-weight:700">${row.A.name}</div>
          <div class="small">ทีม A • ${row.A.role}</div>
        </div>
        <div style="font-weight:800">${row.A.power}</div>
      </div>
      <div class="row" style="opacity:.95">
        <div class="avatar" style="width:34px;height:34px"><img src="${
          row.B.photo || "https://static.api-football.com/players/players.webp"
        }"></div>
        <div style="flex:1">
          <div style="font-weight:700">${row.B.name}</div>
          <div class="small">ทีม B • ${row.B.role}</div>
        </div>
        <div style="font-weight:800">${row.B.power}</div>
      </div>
      <div class="diff-wrap">
        <div class="small" style="display:flex;justify-content:space-between"><span>เปรียบเทียบ</span><span>${label}</span></div>
        <div class="diff-bar"><span class="diff-fill ${cls}" style="width:${fillW}%"></span></div>
      </div>
    `;
          grid.appendChild(card);
        });

        // สลับหน้า
        gameScreen.style.display = "none";
        summaryScreen.style.display = "block";
      }
      function backToGame() {
        summaryScreen.style.display = "none";
        gameScreen.style.display = "grid";
      }

      /* =====================[ เลือกโลโก้ (ตรา/ทีมข้อมูล) ]===================== */
      function onLogoClick(team) {
        if (!state.mode) return alert("โปรดเลือกโหมดก่อน (ปุ่มด้านบนโลโก้)");

        if (state.mode === "crestA" || state.mode === "crestB") {
          const side = state.mode === "crestA" ? "A" : "B";
          state.crest[side] = team;
          byId(
            side === "A" ? "crestA" : "crestB"
          ).innerHTML = `<img src="${team.logo}" alt="${team.name}">`;
          showStatus(`ตั้งตราทีม ${side} เป็น ${team.name}`);
          return;
        }

        // ต้องเลือกตราทั้งสองก่อนถึงจะดึงนักเตะ
        if (!(state.crest.A && state.crest.B))
          return alert(
            "ต้องเลือกตราทีมของผู้เล่นทั้งสองก่อน ถึงจะดึงนักเตะได้"
          );

        const side = state.mode === "dataA" ? "A" : "B";
        if (state.locked[side]) return alert(`ทีม ${side} ถูกยืนยันแล้ว`);
        const set = state.dataTeams[side];
        if (!set.has(team.id) && set.size >= DATA_LIMIT_PER_SIDE) {
          return alert(
            `ทีมข้อมูลของฝั่ง ${side} เต็มโควต้า ${DATA_LIMIT_PER_SIDE} ทีมแล้ว`
          );
        }
        set.add(team.id);
        updateDataCounters();

        loadTeamXI(team.id).then((xi) => renderXI(team, xi));
      }

      async function loadTeamXI(teamId) {
        const season = state.season;
        if (state.XI_CACHE_MEM.has(teamId))
          return state.XI_CACHE_MEM.get(teamId);
        const local = getCache(teamId, season);
        if (local) {
          state.XI_CACHE_MEM.set(teamId, local);
          return local;
        }
        if (state.pending.has(teamId)) return state.pending.get(teamId);

        const p = (async () => {
          showStatus("กำลังโหลด 11 คน …");
          const players = await getPlayersByTeam(teamId, season);
          const xi = pickTopXI(players);
          setCache(teamId, season, xi);
          showStatus("");
          return xi;
        })().finally(() => state.pending.delete(teamId));
        state.pending.set(teamId, p);
        return p;
      }

      /* =====================[ Confirm / Reset ]===================== */
      function confirmTeam(side) {
        if (!canConfirm(side)) return;
        state.locked[side] = true;
        byId(side === "A" ? "tagA" : "tagB").textContent = "ล็อกแล้ว";
        updateConfirmButtons();
        updateBattleButton();
        showStatus(`ทีม ${side} ยืนยันแล้ว (แก้ไขไม่ได้)`);
        setTimeout(() => (statusEl.style.display = "none"), 1600);
      }
      function resetAll() {
        state.locked = { A: false, B: false };
        state.A = FORMATION.map((x) => ({ ...x, player: null }));
        state.B = FORMATION.map((x) => ({ ...x, player: null }));
        state.dataTeams = { A: new Set(), B: new Set() };
        state.lastMatchup = null;
        byId("result").textContent = "";
        byId("sumA").textContent = "— (ซ่อน)";
        byId("sumB").textContent = "— (ซ่อน)";
        byId("summaryBtn").classList.add("disabled");
        updateDataCounters();
        updateConfirmButtons();
        updateBattleButton();
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        backToGame();
      }

      /* =====================[ Boot ]===================== */
      byId("modeCrestA").onclick = () => setMode("crestA");
      byId("modeCrestB").onclick = () => setMode("crestB");
      byId("modeDataA").onclick = () => setMode("dataA");
      byId("modeDataB").onclick = () => setMode("dataB");

      byId("btnCrestA").onclick = () => setMode("crestA");
      byId("btnCrestB").onclick = () => setMode("crestB");
      byId("confirmA").onclick = () => confirmTeam("A");
      byId("confirmB").onclick = () => confirmTeam("B");
      byId("battleBtn").onclick = () => battle();
      byId("summaryBtn").onclick = () => goSummary();
      byId("resetBtn").onclick = () => resetAll();

      byId("backBtn").onclick = () => backToGame();
      byId("playAgainBtn").onclick = () => resetAll();

      byId("seasonSel").addEventListener("change", async (e) => {
        state.season = e.target.value;
        state.XI_CACHE_MEM = new Map();
        state.pending = new Map();
        state.dataTeams = { A: new Set(), B: new Set() };
        updateDataCounters();
        showStatus("กำลังโหลดรายชื่อทีม …");
        state.teams = await getTeams(state.season);
        renderLogoGrid(state.teams);
        showStatus("");
      });

      (async function init() {
        updateDataCounters();
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        setMode("crestA");
        showStatus("กำลังโหลดรายชื่อทีม …");
        state.season = byId("seasonSel").value;
        state.teams = await getTeams(state.season);
        renderLogoGrid(state.teams);
        showStatus("");
      })();
    </script>
  </body>
</html>
