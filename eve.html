<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EPL Draft Duel — โหมดสมจริง (FPL รายสัปดาห์)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0a0f1f;
        --ring: #223047;
        --muted: #9aa4b2;
        --pri: #22d3ee;
        --pri2: #818cf8;
        --ok: #34d399;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        color: #e5e7eb;
        font-family: "Kanit", system-ui, Roboto;
        background: radial-gradient(
            1000px 700px at 15% -10%,
            #1f2937 0%,
            #0f172a 50%,
            #0a0f1f 100%
          )
          fixed;
        min-height: 100svh;
      }
      header {
        position: sticky;
        top: 0;
        padding: 14px 16px;
        border-bottom: 1px solid var(--ring);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0)
        );
        backdrop-filter: blur(6px);
        z-index: 5;
      }
      .container {
        max-width: 1320px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      .grid {
        display: grid;
        gap: 14px;
      }
      .grid-3 {
        grid-template-columns: 1fr 1.3fr 1fr;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid var(--ring);
        border-radius: 14px;
        padding: 12px;
      }
      button {
        cursor: pointer;
        border: 1px solid #0ea5e9;
        background: linear-gradient(180deg, #1d4ed8, #0ea5e9);
        font-weight: 800;
        border-radius: 10px;
        padding: 10px 12px;
      }
      button.ghost {
        background: #0b1220;
        border: 1px solid #334155;
      }
      .small {
        font-size: 12px;
        color: #9aa4b2;
      }
      .logo-picker {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }
      .logo-pick {
        border: 1px solid #2a3650;
        border-radius: 10px;
        padding: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0b1220;
        cursor: pointer;
      }
      .logo-pick img {
        width: 36px;
        height: 36px;
      }
      .crest {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #2a3650;
        overflow: hidden;
      }
      .crest img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .team-section {
        border: 1px solid #2a3650;
        border-radius: 14px;
        padding: 10px;
        background: #0b1220;
      }
      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
      }
      .p-card {
        border: 1px solid #223047;
        border-radius: 14px;
        padding: 10px;
        background: #0a1120;
      }
      .p-head {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 1px solid #334155;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .bar {
        height: 8px;
        background: #0f172a;
        border: 1px solid #263149;
        border-radius: 999px;
        overflow: hidden;
      }
      .bar > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--pri), var(--pri2));
      }
      .formation {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .slot {
        min-height: 96px;
        border: 1px dashed #2b3650;
        border-radius: 12px;
        padding: 8px;
        background: #0b1220;
      }
      .slot.fill {
        border: 1px solid #2dd4bf;
      }
      .slot.wrong {
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
      }
      .sum {
        font-weight: 800;
        font-size: 22px;
      }
      .mask {
        filter: blur(6px);
        opacity: 0.7;
        user-select: none;
      }
      .chip {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        background: #0b1220;
        border: 1px solid #2a3650;
        border-radius: 999px;
        padding: 5px 8px;
      }
      .pill {
        border: 1px solid #334155;
        border-radius: 999px;
        padding: 4px 8px;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 1100px) {
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }
      /* หน้าสรุป */
      #summaryView {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .summary-card {
        max-width: 1100px;
        width: 100%;
        background: #0b1220;
        border: 1px solid #2a3650;
        border-radius: 16px;
        padding: 16px;
      }
      .row2 {
        display: grid;
        grid-template-columns: 1fr 200px 1fr;
        gap: 10px;
        align-items: center;
      }
      .diffbar {
        height: 8px;
        background: #0f172a;
        border: 1px solid #263149;
        border-radius: 999px;
        overflow: hidden;
      }
      .diffA {
        height: 100%;
        float: right;
        background: linear-gradient(90deg, #34d399, #22c55e);
      }
      .diffB {
        height: 100%;
        background: linear-gradient(90deg, #ef4444, #f97316);
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="container"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <h1>⚽ EPL Draft Duel — โหมดสมจริง (FPL รายสัปดาห์)</h1>
        <div style="display: flex; gap: 8px; align-items: center">
          <span class="chip"
            >GW ล่าสุด: <b id="labGW" style="margin-left: 6px">—</b></span
          >
          <span class="chip"
            >อัปเดต: <span id="labUpd" style="margin-left: 6px">—</span></span
          >
          <button id="btnReload" class="ghost">รีโหลดข้อมูล</button>
        </div>
      </div>
    </header>

    <main class="container grid grid-3" id="mainView">
      <!-- ซ้าย: เลือกโลโก้โชว์ (A/B) + เลือกทีมข้อมูลให้ฝั่งที่กำลังใช้งาน -->
      <section class="card">
        <h3 style="margin: 0 0 6px">โลโก้พรีเมียร์ลีก</h3>
        <div class="small">
          คลิกที่โลโก้ซ้ายเพื่อ <b>ตั้งตราทีม (โชว์)</b> ให้ฝั่งที่เลือกด้านล่าง
        </div>
        <div id="logoGrid" class="logo-picker" style="margin-top: 8px"></div>
        <hr style="border-color: #2a3650; opacity: 0.4; margin: 12px 0" />
        <div class="small">
          โหมดเลือกข้อมูล: ตอนนี้กำลังเลือกให้ทีม <b id="activeSide">A</b>.
          คลิกโลโก้ <b>ด้านขวา</b> เพื่อดึง 11 ตัวล่าสุดของทีมนั้น
          (จำกัดเปลี่ยนทีมข้อมูลฝั่งละ 3 ครั้ง)
        </div>
        <div style="display: flex; gap: 8px; margin-top: 8px">
          <button class="ghost" onclick="setActiveDataSide('A')">
            กำลังเลือกให้ทีม A
          </button>
          <button class="ghost" onclick="setActiveDataSide('B')">
            กำลังเลือกให้ทีม B
          </button>
        </div>
        <div class="small" style="margin-top: 8px">
          โควตาเปลี่ยนทีมข้อมูล: A <span id="quotaA">3</span> ครั้ง • B
          <span id="quotaB">3</span> ครั้ง
        </div>
        <hr style="border-color: #2a3650; opacity: 0.4; margin: 12px 0" />
        <div class="small">
          เลือกตราทีมที่จะ <b>โชว์</b> บนกระดาน (ไม่เกี่ยวกับทีมข้อมูล)
        </div>
        <div
          style="display: flex; gap: 8px; align-items: center; margin-top: 6px"
        >
          <button class="ghost" onclick="openCrestPicker('A')">
            เลือกโลโก้ทีม A</button
          ><span id="crestA" class="crest" title="โลโก้ทีม A"></span>
        </div>
        <div
          style="display: flex; gap: 8px; align-items: center; margin-top: 6px"
        >
          <button class="ghost" onclick="openCrestPicker('B')">
            เลือกโลโก้ทีม B</button
          ><span id="crestB" class="crest" title="โลโก้ทีม B"></span>
        </div>
      </section>

      <!-- กลาง: เลือกทีมข้อมูล + แสดงผู้เล่น XI จาก snapshot -->
      <section class="card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0">ทีมข้อมูล (ดึงจาก FPL สัปดาห์ล่าสุด)</h3>
          <div class="small">ฝั่งกำลังเลือก: <b id="labPickSide">A</b></div>
        </div>
        <div id="dataLogos" class="logo-picker" style="margin-top: 8px"></div>
        <div
          id="teamsPlayers"
          style="
            display: grid;
            gap: 12px;
            max-height: 58vh;
            overflow: auto;
            margin-top: 8px;
          "
        ></div>
        <div class="small" id="progress" style="margin-top: 6px"></div>
      </section>

      <!-- ขวา: กระดาน 2 ฝั่ง -->
      <section class="card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <b>ทีม A</b>
          <span>รวมพลัง: <span id="sumA" class="sum mask">ซ่อนอยู่</span></span>
        </div>
        <div class="formation" id="formA"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button
            class="ghost"
            id="btnConfirmA"
            disabled
            onclick="confirmTeam('A')"
          >
            ยืนยันทีม A
          </button>
        </div>

        <hr style="border-color: #2a3650; opacity: 0.4; margin: 10px 0" />

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <b>ทีม B</b>
          <span>รวมพลัง: <span id="sumB" class="sum mask">ซ่อนอยู่</span></span>
        </div>
        <div class="formation" id="formB"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button
            class="ghost"
            id="btnConfirmB"
            disabled
            onclick="confirmTeam('B')"
          >
            ยืนยันทีม B
          </button>
        </div>

        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
          "
        >
          <button id="btnBattle" disabled onclick="battle()">แข่งขัน</button>
          <button class="ghost" onclick="resetBoards()">ล้างกระดาน</button>
        </div>
        <div id="result" class="small" style="margin-top: 8px"></div>
      </section>
    </main>

    <!-- หน้าเฉลยสรุป -->
    <section id="summaryView">
      <div class="summary-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
          "
        >
          <h3 style="margin: 0">
            สรุปผลการแข่งขัน (GW <span id="sumGW">—</span>)
          </h3>
          <div class="small">กดปุ่มปิดเพื่อกลับไปหน้าจัดทีม</div>
        </div>
        <div
          style="display: flex; gap: 12px; align-items: center; margin: 8px 0"
        >
          <span class="crest" id="sumCrestA"></span>
          <b id="sumNameA">ทีม A</b>
          <span class="pill">รวม: <b id="sumTotalA">0</b></span>
          <span style="margin: 0 8px">VS</span>
          <span class="pill">รวม: <b id="sumTotalB">0</b></span>
          <b id="sumNameB">ทีม B</b>
          <span class="crest" id="sumCrestB"></span>
          <div style="margin-left: auto">
            <button class="ghost" onclick="closeSummary()">ปิด</button>
          </div>
        </div>
        <div
          id="sumRows"
          style="display: grid; gap: 6px; margin-top: 8px"
        ></div>
      </div>
    </section>

    <div
      id="status"
      class="small"
      style="position: fixed; right: 12px; bottom: 12px; display: none"
    ></div>

    <script>
      // ===== พาธไฟล์ snapshot ที่ workflow เขียนทุกวันอังคาร =====
      const SNAPSHOT_PATH = "./public/data/fpl_current.json";

      // ===== กำหนดกติกา/ฟอร์เมชัน =====
      const FORMATION = [
        { id: "GK", expect: "Goalkeeper" },
        { id: "RB", expect: "Defender" },
        { id: "RCB", expect: "Defender" },
        { id: "LCB", expect: "Defender" },
        { id: "LB", expect: "Defender" },
        { id: "CM1", expect: "Midfielder" },
        { id: "CM2", expect: "Midfielder" },
        { id: "CAM", expect: "Midfielder" },
        { id: "RW", expect: "Attacker" },
        { id: "ST", expect: "Attacker" },
        { id: "LW", expect: "Attacker" },
      ];
      const WRONG_POS_PENALTY = 0.7; // -30% หากลงผิดตำแหน่ง
      const DATA_SWITCH_LIMIT = 3; // จำกัดเปลี่ยน "ทีมข้อมูล" ฝั่งละ 3 ครั้ง

      // ===== สถานะเกม =====
      const state = {
        fpl: {
          teams: [],
          playersPlayed: [],
          xiByTeam: {},
          gw: null,
          updatedAt: null,
        },
        crestPickSide: "A", // ตอนนี้เลือกโลโก้โชว์ให้ฝั่งไหน
        dataPickSide: "A", // ตอนนี้เลือก "ทีมข้อมูล" ให้ฝั่งไหน
        dataTeamOf: { A: null, B: null }, // ทีมข้อมูลปัจจุบันของแต่ละฝั่ง
        dataSwitchQuota: { A: DATA_SWITCH_LIMIT, B: DATA_SWITCH_LIMIT },
        // รายชื่อ XI ล่าสุดที่แสดงในคอลัมน์กลาง (ของทีมข้อมูลที่เลือก)
        currentXI: [],
        // กระดาน
        A: FORMATION.map((x) => ({ ...x, player: null })),
        B: FORMATION.map((x) => ({ ...x, player: null })),
        confirmed: { A: false, B: false },
        crestImg: { A: "", B: "" },
      };

      // ===== UI helpers =====
      const statusEl = document.getElementById("status");
      const showStatus = (msg, ms = 2200) => {
        statusEl.style.display = "block";
        statusEl.textContent = msg || "";
        if (ms) setTimeout(() => (statusEl.style.display = "none"), ms);
      };
      const clamp = (v, min = 0, max = 100) =>
        Math.max(min, Math.min(max, +v || 0));

      // ===== โหลด snapshot ทุกวันอังคาร =====
      async function loadSnapshot() {
        try {
          const r = await fetch(SNAPSHOT_PATH + "?t=" + Date.now(), {
            cache: "no-cache",
          });
          if (!r.ok) throw new Error("HTTP " + r.status);
          const j = await r.json();
          // สร้างดัชนี playersById
          const playersById = {};
          (j.players_played || []).forEach((p) => {
            playersById[p.id] = p;
          });

          state.fpl.teams = j.teams || [];
          state.fpl.playersPlayed = j.players_played || [];
          state.fpl.playersById = playersById;
          state.fpl.xiByTeam = j.xiByTeam || {};
          state.fpl.gw = j.gw || "-";
          state.fpl.updatedAt = j.generated_at || "—";

          // UI ป้าย GW/เวลา
          document.getElementById("labGW").textContent = state.fpl.gw;
          document.getElementById("labUpd").textContent = new Date(
            state.fpl.updatedAt
          ).toLocaleString("th-TH", { hour12: false });

          renderLogoGrids(); // ทั้งฝั่งโชว์ และฝั่งทีมข้อมูล
          document.getElementById("progress").textContent =
            "เลือกโลโก้ทีมข้อมูลด้านบนเพื่อดู 11 ตัวล่าสุด";
        } catch (e) {
          document.getElementById("progress").textContent =
            "โหลดไม่ได้: ยังไม่มีไฟล์ data — กรุณาเปิดแท็บ Actions แล้วกดรัน workflow เพื่อสร้างไฟล์";
          console.error(e);
        }
      }

      // ===== เรนเดอร์โลโก้ (ฝั่งโชว์ + ทีมข้อมูล) =====
      function renderLogoGrids() {
        const logos = state.fpl.teams.map((t) => ({
          id: t.id,
          name: t.name,
          png: t.badge,
        }));
        // ซ้าย: โลโก้สำหรับ "โชว์" บนกระดาน (กดปุ่ม เลือกฝั่ง A/B ก่อน)
        const left = document.getElementById("logoGrid");
        left.innerHTML = "";
        logos.forEach((t) => {
          const d = document.createElement("div");
          d.className = "logo-pick";
          d.title = t.name;
          d.innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          d.onclick = () => {
            const side = state.crestPickSide;
            document.getElementById(
              side === "A" ? "crestA" : "crestB"
            ).innerHTML = `<img src="${t.png}" alt="${t.name}">`;
            state.crestImg[side] = t.png;
          };
          left.appendChild(d);
        });

        // กลาง: โลโก้สำหรับ "ทีมข้อมูล" (จำกัดเปลี่ยนฝั่งละ 3 ครั้ง)
        const right = document.getElementById("dataLogos");
        right.innerHTML = "";
        logos.forEach((t) => {
          const d = document.createElement("div");
          d.className = "logo-pick";
          d.title = "ข้อมูล: " + t.name;
          d.innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          d.onclick = () => selectDataTeam(state.dataPickSide, t.id);
          right.appendChild(d);
        });
      }

      function openCrestPicker(side) {
        state.crestPickSide = side;
        showStatus(`กำลังเลือกตราโชว์ของทีม ${side} (คลิกโลโก้ทางซ้าย)`);
      }
      function setActiveDataSide(side) {
        state.dataPickSide = side;
        document.getElementById("activeSide").textContent = side;
        document.getElementById("labPickSide").textContent = side;
        showStatus(`กำลังดึงทีมข้อมูลให้ฝั่ง ${side}`);
      }

      function selectDataTeam(side, teamId) {
        // หากเลือกทีมเดิม ไม่หักโควตา
        if (state.dataTeamOf[side] !== teamId) {
          if (state.dataSwitchQuota[side] <= 0) {
            showStatus(`ทีม ${side} ใช้โควตาเปลี่ยนทีมข้อมูลครบแล้ว`, 2500);
            return;
          }
          state.dataSwitchQuota[side]--;
          state.dataTeamOf[side] = teamId;
          document.getElementById("quotaA").textContent =
            state.dataSwitchQuota.A;
          document.getElementById("quotaB").textContent =
            state.dataSwitchQuota.B;
        }
        renderXI(teamId);
      }

      function renderXI(teamId) {
        const ids = state.fpl.xiByTeam[teamId] || [];
        const players = ids
          .map((id) => state.fpl.playersById[id])
          .filter(Boolean);
        state.currentXI = players;
        const teamName =
          (state.fpl.teams.find((t) => t.id === teamId) || {}).name || "—";

        const box = document.getElementById("teamsPlayers");
        box.innerHTML = "";

        const sec = document.createElement("div");
        sec.className = "team-section";
        sec.innerHTML = `<div class="team-header" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div class="crest"><img src="${
          (state.fpl.teams.find((t) => t.id === teamId) || {}).badge || ""
        }"/></div>
        <b>${teamName}</b><span class="small" style="margin-left:auto">11 ตัวล่าสุดที่ลงสนาม (GW ${
          state.fpl.gw
        })</span>
      </div>
      <div class="players-grid"></div>`;
        const grid = sec.querySelector(".players-grid");

        players.forEach((p) => {
          const card = document.createElement("div");
          card.className = "p-card";
          const P = p.powers_gw || {
            ATT: 0,
            CRE: 0,
            DEF: 0,
            FIT: 0,
            CTRL: 0,
            TOTAL: 0,
          };
          const bar = (label, val) =>
            `<div style="margin-top:4px"><div class="small" style="display:flex;justify-content:space-between"><span>${label}</span><span>${Math.round(
              val
            )}</span></div><div class="bar"><span style="width:${clamp(
              val
            )}%"></span></div></div>`;
          card.innerHTML = `
          <div class="p-head">
            <div class="avatar"><img src="${
              p.photo
            }" onerror="this.src='https://static.api-football.com/players/players.webp'"></div>
            <div><div style="font-weight:700">${
              p.name
            }</div><div class="small">${p.team} • ${p.role}</div></div>
            <div style="margin-left:auto;text-align:right"><div style="font-size:22px;font-weight:800">${
              P.TOTAL
            }</div><div class="small">POWER</div></div>
          </div>
          ${bar("ATT", P.ATT)}${bar("CRE", P.CRE)}${bar("DEF", P.DEF)}${bar(
            "FIT",
            P.FIT
          )}${bar("CTRL", P.CTRL)}
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="ghost">+ ทีม A</button>
            <button class="ghost">+ ทีม B</button>
          </div>
        `;
          const btns = card.querySelectorAll("button");
          btns[0].onclick = () => quickAdd("A", p);
          btns[1].onclick = () => quickAdd("B", p);
          grid.appendChild(card);
        });

        box.appendChild(sec);
        document.getElementById(
          "progress"
        ).textContent = `แสดงผู้เล่นของ ${teamName}`;
      }

      function isRoleMatch(expect, role) {
        if (expect === "Goalkeeper") return role === "Goalkeeper";
        if (expect === "Defender") return role === "Defender";
        if (expect === "Midfielder") return role === "Midfielder";
        if (expect === "Attacker") return role === "Attacker";
        return false;
      }

      function applyPenalty(player, isWrong) {
        const f = isWrong ? WRONG_POS_PENALTY : 1;
        const P = player.powers_gw || {
          ATT: 0,
          CRE: 0,
          DEF: 0,
          FIT: 0,
          CTRL: 0,
        };
        return Math.round(
          (P.ATT * f + P.CRE * f + P.DEF * f + P.FIT * f + P.CTRL * f) / 5
        );
      }

      function renderBoard(side, rootId) {
        const team = side === "A" ? state.A : state.B;
        const root = document.getElementById(rootId);
        root.innerHTML = "";
        team.forEach((slot, idx) => {
          const has = !!slot.player;
          const wrong = has && !isRoleMatch(slot.expect, slot.player.role);
          const d = document.createElement("div");
          d.className = `slot ${has ? "fill" : ""} ${wrong ? "wrong" : ""}`;
          d.innerHTML = `<div class="small" style="opacity:.8">${slot.id} (${
            slot.expect
          })</div>
          ${
            has
              ? `
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <div class="avatar" style="width:38px;height:38px"><img src="${
              slot.player.photo
            }"></div>
            <div>
              <div style="font-weight:700">${slot.player.name}</div>
              <div class="small">${slot.player.role}${
                  wrong
                    ? ' • <span style="color:#fecaca">ผิดตำแหน่ง</span>'
                    : ""
                }</div>
              <div class="small">Power: ${slot.player.adjTotal}</div>
            </div>
            <!-- ไม่มีปุ่มเอาออก เพื่อความยุติธรรม -->
          </div>`
              : `<div class="small" style="opacity:.7">กด + จากรายการตรงกลางเพื่อเพิ่ม</div>`
          }`;
          // ไม่รองรับ drop ทับถ้าช่องมีแล้ว (กันเปลี่ยนใจหลังเห็นอีกฝั่ง)
          d.addEventListener("dragover", (e) => {
            if (!has) e.preventDefault();
          });
          d.addEventListener("drop", (e) => {
            if (has) return;
            e.preventDefault();
            const data = JSON.parse(
              e.dataTransfer.getData("text/plain") || "{}"
            );
            const p = state.fpl.playersById[data.pid];
            if (p) place(side, idx, p);
          });
          root.appendChild(d);
        });
        refreshSums();
        document.getElementById(
          side === "A" ? "btnConfirmA" : "btnConfirmB"
        ).disabled = !team.every((x) => !!x.player);
        document.getElementById("btnBattle").disabled = !(
          state.confirmed.A && state.confirmed.B
        );
      }

      function place(side, idx, player) {
        if (state.confirmed[side]) {
          showStatus(`ทีม ${side} ถูกล็อกแล้ว`);
          return;
        }
        // กันซ้ำข้ามทีม
        const duplicated = [...state.A, ...state.B].some(
          (s) => s.player && s.player.id === player.id
        );
        if (duplicated) {
          showStatus("ผู้เล่นคนนี้ถูกเลือกไปแล้ว");
          return;
        }

        const team = side === "A" ? state.A : state.B;
        if (team[idx].player) {
          showStatus("ช่องนี้มีผู้เล่นแล้ว");
          return;
        }

        const wrong = !isRoleMatch(team[idx].expect, player.role);
        const adj = applyPenalty(player, wrong);
        team[idx].player = {
          ...player,
          id: player.id,
          role: player.role,
          photo: player.photo,
          name: player.name,
          adjTotal: adj,
          wrong,
        };

        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }

      function quickAdd(side, player) {
        if (state.confirmed[side]) {
          showStatus(`ทีม ${side} ถูกล็อกแล้ว`);
          return;
        }
        // กันซ้ำข้ามทีม
        const duplicated = [...state.A, ...state.B].some(
          (s) => s.player && s.player.id === player.id
        );
        if (duplicated) {
          showStatus("ผู้เล่นคนนี้ถูกเลือกไปแล้ว");
          return;
        }

        const team = side === "A" ? state.A : state.B;
        let idx = team.findIndex(
          (s) => !s.player && isRoleMatch(s.expect, player.role)
        );
        if (idx < 0) idx = team.findIndex((s) => !s.player);
        if (idx < 0) return showStatus(`ทีม ${side} ครบ 11 แล้ว`);
        place(side, idx, player);
      }

      function refreshSums() {
        const sumA = state.A.reduce(
          (s, x) => s + (x.player ? x.player.adjTotal : 0),
          0
        );
        const sumB = state.B.reduce(
          (s, x) => s + (x.player ? x.player.adjTotal : 0),
          0
        );
        const elA = document.getElementById("sumA");
        const elB = document.getElementById("sumB");
        elA.textContent =
          state.confirmed.A && state.confirmed.B ? sumA : "ซ่อนอยู่";
        elB.textContent =
          state.confirmed.A && state.confirmed.B ? sumB : "ซ่อนอยู่";
        elA.classList.toggle("mask", !(state.confirmed.A && state.confirmed.B));
        elB.classList.toggle("mask", !(state.confirmed.A && state.confirmed.B));
      }

      function confirmTeam(side) {
        const team = side === "A" ? state.A : state.B;
        if (!team.every((x) => !!x.player))
          return showStatus(`ทีม ${side} ยังไม่ครบ 11`);
        state.confirmed[side] = true;
        showStatus(`ล็อกทีม ${side} แล้ว`);
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }

      function resetBoards() {
        if (state.confirmed.A || state.confirmed.B) {
          if (!confirm("รีเซ็ตทั้งหมดและปลดล็อกทีม?")) return;
        }
        state.A = FORMATION.map((x) => ({ ...x, player: null }));
        state.B = FORMATION.map((x) => ({ ...x, player: null }));
        state.confirmed = { A: false, B: false };
        state.dataSwitchQuota = { A: DATA_SWITCH_LIMIT, B: DATA_SWITCH_LIMIT };
        state.dataTeamOf = { A: null, B: null };
        document.getElementById("quotaA").textContent = state.dataSwitchQuota.A;
        document.getElementById("quotaB").textContent = state.dataSwitchQuota.B;
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        refreshSums();
        document.getElementById("btnBattle").disabled = true;
      }

      function battle() {
        const cntA = state.A.filter((s) => s.player).length,
          cntB = state.B.filter((s) => s.player).length;
        if (cntA < 11 || cntB < 11) return alert("ต้องครบ 11 คนทั้งสองทีม");
        if (!(state.confirmed.A && state.confirmed.B))
          return alert("ต้องกดยืนยันทั้งสองทีมก่อน");

        const totalA = state.A.reduce((s, x) => s + x.player.adjTotal, 0);
        const totalB = state.B.reduce((s, x) => s + x.player.adjTotal, 0);
        const resEl = document.getElementById("result");
        resEl.textContent =
          totalA > totalB
            ? `ทีม A ชนะ ${totalA} ต่อ ${totalB}`
            : totalB > totalA
            ? `ทีม B ชนะ ${totalB} ต่อ ${totalA}`
            : `เสมอ ${totalA} ต่อ ${totalB}`;

        // เปิดหน้าเฉลยแบบตำแหน่งต่อ-ตำแหน่ง
        openSummary(totalA, totalB);
      }

      function openSummary(totalA, totalB) {
        document.getElementById("sumGW").textContent = state.fpl.gw || "-";
        document.getElementById("sumTotalA").textContent = totalA;
        document.getElementById("sumTotalB").textContent = totalB;
        document.getElementById("sumCrestA").innerHTML = state.crestImg.A
          ? `<img src="${state.crestImg.A}">`
          : "";
        document.getElementById("sumCrestB").innerHTML = state.crestImg.B
          ? `<img src="${state.crestImg.B}">`
          : "";

        const rows = document.getElementById("sumRows");
        rows.innerHTML = "";
        for (let i = 0; i < FORMATION.length; i++) {
          const slotA = state.A[i],
            slotB = state.B[i];
          const a = slotA.player,
            b = slotB.player;
          const av = a ? a.adjTotal : 0,
            bv = b ? b.adjTotal : 0;
          const diff = av - bv;
          const abs = Math.min(100, Math.abs(diff));
          const row = document.createElement("div");
          row.className = "row2";
          row.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center">
            <div class="avatar" style="width:40px;height:40px">${
              a ? `<img src="${a.photo}">` : ""
            }</div>
            <div>
              <div style="font-weight:700">${a ? a.name : "—"}</div>
              <div class="small">${FORMATION[i].id} (${
            FORMATION[i].expect
          }) • ${a ? a.role : "-"}</div>
              <div class="small">Power: ${av}</div>
            </div>
          </div>
          <div>
            <div class="small" style="text-align:center;margin-bottom:4px">ต่างกัน ${
              diff > 0 ? `+${diff}` : diff
            } แต้ม</div>
            <div class="diffbar">
              ${
                diff >= 0
                  ? `<div class="diffA" style="width:${abs}%;"></div>`
                  : `<div class="diffB" style="width:${abs}%;"></div>`
              }
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <div>
              <div style="font-weight:700;text-align:right">${
                b ? b.name : "—"
              }</div>
              <div class="small" style="text-align:right">${FORMATION[i].id} (${
            FORMATION[i].expect
          }) • ${b ? b.role : "-"}</div>
              <div class="small" style="text-align:right">Power: ${bv}</div>
            </div>
            <div class="avatar" style="width:40px;height:40px">${
              b ? `<img src="${b.photo}">` : ""
            }</div>
          </div>
        `;
          rows.appendChild(row);
        }
        document.getElementById("summaryView").style.display = "flex";
      }
      function closeSummary() {
        document.getElementById("summaryView").style.display = "none";
      }

      // ===== Boot =====
      document.getElementById("btnReload").onclick = loadSnapshot;
      document.getElementById("sumNameA").textContent = "ทีม A";
      document.getElementById("sumNameB").textContent = "ทีม B";
      document.getElementById("quotaA").textContent = state.dataSwitchQuota.A;
      document.getElementById("quotaB").textContent = state.dataSwitchQuota.B;

      // เรนเดอร์กระดานว่าง + โหลด snapshot
      (function init() {
        // สร้างพื้นที่กระดาน
        const makeBoard = (side, root) => {
          const team = side === "A" ? state.A : state.B;
          team.forEach((_, i) => {}); // placeholder
          renderBoard(side, root);
        };
        makeBoard("A", "formA");
        makeBoard("B", "formB");
        setActiveDataSide("A");
        loadSnapshot();
      })();
    </script>
  </body>
</html>
