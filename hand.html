<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EPL Draft Duel — API-FOOTBALL (RapidAPI)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0a0f1f;
        --ring: #223047;
        --muted: #9aa4b2;
        --pri: #22d3ee;
        --pri2: #818cf8;
        --ok: #34d399;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        color: #e5e7eb;
        font-family: "Kanit", system-ui, Roboto;
        background: radial-gradient(
            1000px 700px at 15% -10%,
            #1f2937 0%,
            #0f172a 50%,
            #0a0f1f 100%
          )
          fixed;
        min-height: 100svh;
      }
      header {
        position: sticky;
        top: 0;
        padding: 14px 16px;
        border-bottom: 1px solid var(--ring);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0)
        );
        backdrop-filter: blur(6px);
        z-index: 5;
      }
      .container {
        max-width: 1320px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      .grid {
        display: grid;
        gap: 14px;
      }
      .grid-3 {
        grid-template-columns: 1fr 1.3fr 1fr;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid var(--ring);
        border-radius: 14px;
        padding: 12px;
      }
      button {
        cursor: pointer;
        border: 1px solid #0ea5e9;
        background: linear-gradient(180deg, #1d4ed8, #0ea5e9);
        font-weight: 800;
        border-radius: 10px;
        padding: 10px 12px;
      }
      button.ghost {
        background: #0b1220;
        border: 1px solid #334155;
      }
      .small {
        font-size: 12px;
        color: #9aa4b2;
      }
      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
      }
      .p-card {
        border: 1px solid #223047;
        border-radius: 14px;
        padding: 10px;
        background: #0a1120;
      }
      .p-head {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 1px solid #334155;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .bars {
        display: grid;
        gap: 6px;
      }
      .bar {
        height: 8px;
        background: #0f172a;
        border: 1px solid #263149;
        border-radius: 999px;
        overflow: hidden;
      }
      .bar > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--pri), var(--pri2));
      }
      .team-section {
        border: 1px solid #2a3650;
        border-radius: 14px;
        padding: 10px;
        background: #0b1220;
      }
      .team-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .crest {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #2a3650;
        overflow: hidden;
      }
      .crest img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .formation {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .slot {
        min-height: 96px;
        border: 1px dashed #2b3650;
        border-radius: 12px;
        padding: 8px;
        background: #0b1220;
      }
      .slot.fill {
        border: 1px solid #2dd4bf;
      }
      .slot.wrong {
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
      }
      .sum {
        font-weight: 800;
        font-size: 22px;
      }
      .logo-picker {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }
      .logo-pick {
        border: 1px solid #2a3650;
        border-radius: 10px;
        padding: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0b1220;
        cursor: pointer;
      }
      .logo-pick img {
        width: 40px;
        height: 40px;
      }
      @media (max-width: 1100px) {
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="container"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
        "
      >
        <h1>⚽ EPL Draft Duel — RapidAPI / API-FOOTBALL</h1>
        <div
          style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap"
        >
          <label class="small"
            >Season:
            <select id="seasonSel">
              <option value="2024" selected>2024/25</option>
              <option value="2023">2023/24</option>
            </select>
          </label>
          <button id="btnLoad">โหลดนักเตะ 20 ทีม (11 คน/ทีม)</button>
        </div>
      </div>
    </header>

    <main class="container grid grid-3">
      <!-- ซ้าย: เลือกตรา -->
      <section class="card">
        <h3 style="margin: 0 0 6px">โลโก้พรีเมียร์ลีก (เลือกเพื่อแสดงผล)</h3>
        <div class="small">
          คลิกเพื่อเลือกโลโก้ให้ทีม A หรือ B จากปุ่มใต้กระดานทางขวา
        </div>
        <div id="allLogos" class="logo-picker" style="margin-top: 8px"></div>
        <div class="small" style="margin-top: 10px; opacity: 0.8">
          ⚠️ ส่วน API ด้านล่างนี้ต้องใส่คีย์ (ดูในโค้ดบรรทัด CONFIG)
        </div>
      </section>

      <!-- กลาง: รายชื่อนักเตะทีมละ 11 -->
      <section class="card">
        <h3 style="margin: 0 0 6px">นักเตะจาก API-FOOTBALL — ทีมละ 11 คน</h3>
        <div
          id="teamsPlayers"
          style="display: grid; gap: 12px; max-height: 68vh; overflow: auto"
        ></div>
        <div class="small" id="progress" style="margin-top: 6px"></div>
      </section>

      <!-- ขวา: กระดาน 2 ทีม -->
      <section class="card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <b>ทีม A</b><span>รวมพลัง: <span id="sumA" class="sum">0</span></span>
        </div>
        <div class="formation" id="formA"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button class="ghost" onclick="openLogoPicker('A')">
            เลือกโลโก้ทีม A
          </button>
          <span id="crestA" class="crest" title="โลโก้ทีม A"></span>
        </div>
        <hr style="border-color: #2a3650; opacity: 0.4" />
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <b>ทีม B</b><span>รวมพลัง: <span id="sumB" class="sum">0</span></span>
        </div>
        <div class="formation" id="formB"></div>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 6px;
          "
        >
          <button class="ghost" onclick="openLogoPicker('B')">
            เลือกโลโก้ทีม B
          </button>
          <span id="crestB" class="crest" title="โลโก้ทีม B"></span>
        </div>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
          "
        >
          <button onclick="battle()">แข่งขัน</button>
          <button class="ghost" onclick="resetBoards()">ล้างกระดาน</button>
        </div>
        <div id="result" class="small" style="margin-top: 8px"></div>
      </section>
    </main>

    <div
      id="status"
      class="small"
      style="position: fixed; right: 12px; bottom: 12px; display: none"
    ></div>

    <script>
      /* =====================[ CONFIG ]===================== */
      // ⚠️ ใส่คีย์ RapidAPI ของคุณตรงนี้ (อย่าแชร์ต่อสาธารณะ)
      // ตัวอย่าง: const RAPID_API_KEY = "29d9ba18bfmshd94e9259bed4e21p1b054fjsne176c557d97a";
      const RAPID_API_KEY =
        "e80aa2edc5msha00ac44ae47cf26p17b63ajsn694a49625495"; // <-- ใส่คีย์ตรงนี้
      const API_HOST = "api-football-v1.p.rapidapi.com";
      const LEAGUE_ID = 39; // Premier League
      const MAX_PAGES_PER_TEAM = 0; // 0 = ดึงให้ครบทุกหน้า, >0 = จำกัดจำนวนหน้าเพื่อความเร็ว

      /* =====================[ โลโก้ทีม EPL ]===================== */
      const TEAM_LOGOS = [
        {
          id: 1,
          name: "Arsenal",
          png: "https://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg",
        },
        {
          id: 2,
          name: "Aston Villa",
          png: "https://upload.wikimedia.org/wikipedia/en/f/f9/Aston_Villa_FC_2016.svg",
        },
        {
          id: 3,
          name: "Bournemouth",
          png: "https://upload.wikimedia.org/wikipedia/en/e/e5/AFC_Bournemouth_%282013%29.svg",
        },
        {
          id: 4,
          name: "Brentford",
          png: "https://upload.wikimedia.org/wikipedia/en/2/2a/Brentford_FC_crest.svg",
        },
        {
          id: 5,
          name: "Brighton",
          png: "https://upload.wikimedia.org/wikipedia/en/f/fd/Brighton_%26_Hove_Albion_logo.svg",
        },
        {
          id: 6,
          name: "Chelsea",
          png: "https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg",
        },
        {
          id: 7,
          name: "Crystal Palace",
          png: "https://upload.wikimedia.org/wikipedia/en/0/0c/Crystal_Palace_FC_logo.svg",
        },
        {
          id: 8,
          name: "Everton",
          png: "https://upload.wikimedia.org/wikipedia/en/7/7c/Everton_FC_logo.svg",
        },
        {
          id: 9,
          name: "Leicester",
          png: "https://upload.wikimedia.org/wikipedia/en/6/63/Leicester02.png",
        },
        {
          id: 10,
          name: "Liverpool",
          png: "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg",
        },
        {
          id: 11,
          name: "Man City",
          png: "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg",
        },
        {
          id: 12,
          name: "Man United",
          png: "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg",
        },
        {
          id: 13,
          name: "Newcastle",
          png: "https://upload.wikimedia.org/wikipedia/en/5/56/Newcastle_United_Logo.svg",
        },
        {
          id: 14,
          name: "Nottingham Forest",
          png: "https://upload.wikimedia.org/wikipedia/en/6/67/Nottingham_Forest_logo.svg",
        },
        {
          id: 15,
          name: "Sheffield Utd",
          png: "https://upload.wikimedia.org/wikipedia/en/9/9c/Sheffield_United_FC_logo.svg",
        },
        {
          id: 16,
          name: "Tottenham",
          png: "https://upload.wikimedia.org/wikipedia/en/b/b4/Tottenham_Hotspur.svg",
        },
        {
          id: 17,
          name: "West Ham",
          png: "https://upload.wikimedia.org/wikipedia/en/c/c2/West_Ham_United_FC_logo.svg",
        },
        {
          id: 18,
          name: "Wolves",
          png: "https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg",
        },
        {
          id: 19,
          name: "Fulham",
          png: "https://upload.wikimedia.org/wikipedia/en/3/3e/Fulham_FC_%28shield%29.svg",
        },
        {
          id: 20,
          name: "Ipswich",
          png: "https://upload.wikimedia.org/wikipedia/en/4/43/Ipswich_Town.svg",
        },
      ];

      /* =====================[ กติกา/กระดาน ]===================== */
      const WRONG_POS_PENALTY = 0.7;
      const FORMATION = [
        { id: "GK", expect: "Goalkeeper" },
        { id: "RB", expect: "Defender" },
        { id: "RCB", expect: "Defender" },
        { id: "LCB", expect: "Defender" },
        { id: "LB", expect: "Defender" },
        { id: "CM1", expect: "Midfielder" },
        { id: "CM2", expect: "Midfielder" },
        { id: "CAM", expect: "Midfielder" },
        { id: "RW", expect: "Attacker" },
        { id: "ST", expect: "Attacker" },
        { id: "LW", expect: "Attacker" },
      ];
      const state = {
        A: FORMATION.map((x) => ({ ...x, player: null })),
        B: FORMATION.map((x) => ({ ...x, player: null })),
        xiByTeam: {}, // teamId -> players[11]
        api: { teams: [], playersByTeam: {} },
        logoPickSide: "A",
      };

      /* =====================[ Helper UI ]===================== */
      const statusEl = document.getElementById("status");
      const showStatus = (msg) => {
        statusEl.style.display = "block";
        statusEl.textContent = msg || "";
      };

      /* โลโก้กริดซ้าย */
      (function renderAllLogos() {
        const box = document.getElementById("allLogos");
        TEAM_LOGOS.forEach((t) => {
          const d = document.createElement("div");
          d.className = "logo-pick";
          d.title = t.name;
          d.innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          d.onclick = () => {
            const side = state.logoPickSide;
            document.getElementById(
              side === "A" ? "crestA" : "crestB"
            ).innerHTML = `<img src="${t.png}" alt="${t.name}">`;
          };
          box.appendChild(d);
        });
      })();

      function openLogoPicker(side) {
        state.logoPickSide = side;
        showStatus(`กำลังเลือกโลโก้สำหรับทีม ${side} — คลิกไอคอนทางซ้ายได้เลย`);
        setTimeout(() => (statusEl.style.display = "none"), 2500);
      }

      /* =====================[ กระดาน ]===================== */
      function isRoleMatch(expect, role) {
        return expect === role;
      }
      function applyPenalty(player, isWrong) {
        const f = isWrong ? WRONG_POS_PENALTY : 1;
        const P = player.powers;
        return Math.round(
          (P.ATT * f + P.CRE * f + P.DEF * f + P.FIT * f + P.CTRL * f) / 5
        );
      }
      function renderBoard(side, rootId) {
        const team = side === "A" ? state.A : state.B;
        const root = document.getElementById(rootId);
        root.innerHTML = "";
        team.forEach((slot, idx) => {
          const has = !!slot.player;
          const wrong = has && !isRoleMatch(slot.expect, slot.player.role);
          const d = document.createElement("div");
          d.className = `slot ${has ? "fill" : ""} ${wrong ? "wrong" : ""}`;
          d.innerHTML = `<div class="small" style="opacity:.8">${slot.id} (${
            slot.expect
          })</div>
      ${
        has
          ? `
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div class="avatar" style="width:38px;height:38px"><img src="${
            slot.player.photo
          }"></div>
          <div>
            <div style="font-weight:700">${slot.player.name}</div>
            <div class="small">${slot.player.role}${
              wrong ? ' • <span style="color:#fecaca">ผิดตำแหน่ง</span>' : ""
            }</div>
            <div class="small">Power: ${slot.player.adjTotal}</div>
          </div>
          <div style="margin-left:auto"><button class="ghost" onclick="removeFromSlot('${side}',${idx})">เอาออก</button></div>
        </div>`
          : `<div class="small" style="opacity:.7">ลากการ์ด หรือกด + ทีม ${side}</div>`
      }`;
          d.addEventListener("dragover", (e) => e.preventDefault());
          d.addEventListener("drop", (e) => {
            e.preventDefault();
            const data = JSON.parse(
              e.dataTransfer.getData("text/plain") || "{}"
            );
            const p = (state.xiByTeam[data.teamId] || []).find(
              (x) => x.id === data.pid
            );
            if (p) place(side, idx, p);
          });
          root.appendChild(d);
        });
        refreshSums();
      }
      function removeFromSlot(side, idx) {
        const team = side === "A" ? state.A : state.B;
        team[idx].player = null;
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }
      function place(side, idx, player) {
        const team = side === "A" ? state.A : state.B;
        if (team.some((s) => s.player && s.player.id === player.id))
          return alert("ผู้เล่นนี้อยู่ในทีมแล้ว");
        const wrong = !isRoleMatch(team[idx].expect, player.role);
        team[idx].player = {
          ...player,
          adjTotal: applyPenalty(player, wrong),
          wrong,
        };
        renderBoard("A", "formA");
        renderBoard("B", "formB");
      }
      function quickAdd(side, player) {
        const team = side === "A" ? state.A : state.B;
        let i = team.findIndex(
          (s) => !s.player && isRoleMatch(s.expect, player.role)
        );
        if (i < 0) i = team.findIndex((s) => !s.player);
        if (i < 0) return alert(`ทีม ${side} ครบ 11 แล้ว`);
        place(side, i, player);
      }
      function refreshSums() {
        const sumA = state.A.reduce(
          (s, x) => s + (x.player ? x.player.adjTotal : 0),
          0
        );
        const sumB = state.B.reduce(
          (s, x) => s + (x.player ? x.player.adjTotal : 0),
          0
        );
        document.getElementById("sumA").textContent = sumA;
        document.getElementById("sumB").textContent = sumB;
      }
      function battle() {
        const aCnt = state.A.filter((s) => s.player).length,
          bCnt = state.B.filter((s) => s.player).length;
        if (aCnt < 11 || bCnt < 11) return alert("ต้องครบ 11 คนทั้งสองทีม");
        const a = state.A.reduce((s, x) => s + x.player.adjTotal, 0);
        const b = state.B.reduce((s, x) => s + x.player.adjTotal, 0);
        document.getElementById("result").textContent =
          a > b
            ? `ทีม A ชนะ ${a} ต่อ ${b}`
            : b > a
            ? `ทีม B ชนะ ${b} ต่อ ${a}`
            : `เสมอ ${a} ต่อ ${b}`;
      }

      /* =====================[ คำนวณค่าพลังจากสถิติ API-FOOTBALL ]===================== */
      const clamp = (v, min = 0, max = 100) =>
        Math.max(min, Math.min(max, +v || 0));
      const per90 = (v, mins) => ((+v || 0) * 90) / Math.max(1, +mins || 0);
      function mapRole(pos) {
        // รองรับทั้ง "Goalkeeper"/"G" ฯลฯ
        if (!pos) return "Attacker";
        const P = String(pos).toLowerCase();
        if (P.startsWith("g")) return "Goalkeeper";
        if (P.startsWith("d")) return "Defender";
        if (P.startsWith("m")) return "Midfielder";
        return "Attacker";
      }
      function powerFromStats(s) {
        const m = s.games?.minutes || 0;
        const g90 = per90(s.goals?.total, m);
        const a90 = per90(s.goals?.assists, m);
        const sh90 = per90(s.shots?.total, m);
        const tk90 = per90(s.tackles?.total, m);
        const duelRate = s.duels?.total
          ? (100 * (s.duels?.won || 0)) / (s.duels.total || 1)
          : 0;
        const passAcc = +s.passes?.accuracy || 0;
        const cards = (s.cards?.yellow || 0) * 2 + (s.cards?.red || 0) * 8;

        const ATT = clamp(g90 * 60 + a90 * 25 + sh90 * 5);
        const CRE = clamp(passAcc * 0.6 + a90 * 30);
        const DEF = clamp(tk90 * 15 + duelRate * 0.4 + (s.interceptions || 0));
        const FIT = clamp(Math.min(1, m / (38 * 90)) * 100);
        const CTRL = clamp(90 - cards);

        return {
          ATT,
          CRE,
          DEF,
          FIT,
          CTRL,
          TOTAL: Math.round((ATT + CRE + DEF + FIT + CTRL) / 5),
        };
      }

      /* =====================[ เรียก API-FOOTBALL ]===================== */
      function headers() {
        if (!RAPID_API_KEY || RAPID_API_KEY === "YOUR_RAPIDAPI_KEY") {
          alert("ยังไม่ได้ใส่ RAPID_API_KEY ในโค้ด (ส่วน CONFIG)");
        }
        return { "X-RapidAPI-Key": RAPID_API_KEY, "X-RapidAPI-Host": API_HOST };
      }
      async function fetchJSON(url) {
        const r = await fetch(url, { headers: headers() });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      }
      async function getPLTeams(season) {
        const j = await fetchJSON(
          `https://${API_HOST}/v3/teams?league=${LEAGUE_ID}&season=${season}`
        );
        return j.response.map((x) => ({ id: x.team.id, name: x.team.name }));
      }
      async function getPlayersWithStatsByTeam(teamId, season) {
        let page = 1,
          out = [],
          total = 1;
        while (page <= total) {
          const j = await fetchJSON(
            `https://${API_HOST}/v3/players?team=${teamId}&season=${season}&page=${page}`
          );
          out.push(...j.response);
          total = j.paging?.total || 1;
          page++;
          if (MAX_PAGES_PER_TEAM > 0 && page > MAX_PAGES_PER_TEAM) break;
        }
        // map เฉพาะสถิติของลีก EPL
        return out
          .map((x) => {
            const s = (x.statistics || []).find(
              (s) => s.league?.id === LEAGUE_ID
            );
            return s ? { player: x.player, stats: s } : null;
          })
          .filter(Boolean);
      }
      function pickTopXI(players) {
        const byPos = (want) =>
          players
            .filter((p) => mapRole(p.stats.games?.position) === want)
            .sort(
              (a, b) =>
                (b.stats.games?.minutes || 0) - (a.stats.games?.minutes || 0)
            );
        const gk = byPos("Goalkeeper").slice(0, 1);
        const df = byPos("Defender").slice(0, 4);
        const mf = byPos("Midfielder").slice(0, 3);
        const fw = byPos("Attacker").slice(0, 3);
        let xi = [...gk, ...df, ...mf, ...fw];
        if (xi.length < 11) {
          const rest = players
            .filter((p) => !xi.includes(p))
            .sort(
              (a, b) =>
                (b.stats.games?.minutes || 0) - (a.stats.games?.minutes || 0)
            );
          xi = xi.concat(rest.slice(0, 11 - xi.length));
        }
        return xi.map((p) => ({
          id: p.player.id,
          name: `${p.player.firstname || ""} ${
            p.player.lastname || p.player.name || ""
          }`.trim(),
          photo:
            p.player.photo ||
            `https://static.api-football.com/players/players.webp`,
          role: mapRole(p.stats.games?.position),
          teamName: p.stats.team?.name || "",
          teamId: p.stats.team?.id,
          minutes: p.stats.games?.minutes || 0,
          powers: powerFromStats(p.stats),
        }));
      }

      /* =====================[ เรนเดอร์ส่วนรายทีม/ผู้เล่น ]===================== */
      function bar(label, val) {
        val = Math.round(val);
        let color = "linear-gradient(90deg,#22d3ee,#818cf8)";
        if (val >= 80) color = "linear-gradient(90deg,#34d399,#22c55e)";
        else if (val < 40) color = "linear-gradient(90deg,#ef4444,#f97316)";
        return `<div><div class="small" style="display:flex;justify-content:space-between"><span>${label}</span><span>${val}</span></div><div class="bar"><span style="width:${val}%;background:${color}"></span></div></div>`;
      }
      function teamBadge(teamId) {
        const m = TEAM_LOGOS.find((x) => x.id === teamId);
        return (
          m?.png ||
          `https://resources.premierleague.com/premierleague/badges/70/t${teamId}.png`
        );
      }
      function buildAllTeamsXI(teams) {
        const box = document.getElementById("teamsPlayers");
        box.innerHTML = "";
        const progress = document.getElementById("progress");
        const teamsSorted = teams
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name));
        teamsSorted.forEach((t, i) => {
          const xi = state.xiByTeam[t.id] || [];
          const sec = document.createElement("div");
          sec.className = "team-section";
          sec.innerHTML = `<div class="team-header"><div class="crest"><img src="${teamBadge(
            t.id
          )}" /></div><b>${
            t.name
          }</b><span class="small" style="margin-left:auto">${
            xi.length || 0
          } / 11 คน</span></div><div class="players-grid"></div>`;
          const grid = sec.querySelector(".players-grid");
          xi.forEach((p) => {
            const card = document.createElement("div");
            card.className = "p-card";
            card.setAttribute("draggable", "true");
            card.innerHTML = `
        <div class="p-head">
          <div class="avatar"><img src="${
            p.photo
          }" onerror="this.src='https://static.api-football.com/players/players.webp'"></div>
          <div><div style="font-weight:700">${p.name}</div><div class="small">${
              t.name
            } • ${p.role}</div></div>
          <div style="margin-left:auto;text-align:right"><div style="font-size:22px;font-weight:800">${
            p.powers.TOTAL
          }</div><div class="small">POWER</div></div>
        </div>
        <div class="bars" style="margin-top:6px">
          ${bar("ATT", p.powers.ATT)}${bar("CRE", p.powers.CRE)}${bar(
              "DEF",
              p.powers.DEF
            )}${bar("FIT", p.powers.FIT)}${bar("CTRL", p.powers.CTRL)}
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="ghost">+ ทีม A</button><button class="ghost">+ ทีม B</button>
        </div>`;
            card.querySelectorAll("button")[0].onclick = () => quickAdd("A", p);
            card.querySelectorAll("button")[1].onclick = () => quickAdd("B", p);
            card.addEventListener("dragstart", (ev) =>
              ev.dataTransfer.setData(
                "text/plain",
                JSON.stringify({ pid: p.id, teamId: t.id })
              )
            );
            grid.appendChild(card);
          });
          box.appendChild(sec);
          progress.textContent = `โหลด/คัด 11 คน: ${i + 1}/${
            teamsSorted.length
          }`;
        });
        progress.textContent = "เสร็จสิ้น ✓";
      }

      /* =====================[ โหลดข้อมูลครบลูป ]===================== */
      async function loadLeague() {
        const season = document.getElementById("seasonSel").value;
        try {
          showStatus("กำลังดึงรายชื่อทีม EPL …");
          const teams = await getPLTeams(season);
          state.api.teams = teams;
          showStatus(
            `พบทีม ${teams.length} ทีม — กำลังดึงผู้เล่น/สถิติทีละทีม …`
          );
          const progress = document.getElementById("progress");
          progress.textContent = "";
          // ดึงทีละทีม (กันโดน rate-limit) — ถ้าอยากเร็วขึ้น สามารถทำเป็น Promise.all แบบ batch ได้
          for (let i = 0; i < teams.length; i++) {
            const t = teams[i];
            showStatus(`ดึงผู้เล่นทีม: ${t.name} (${i + 1}/${teams.length}) …`);
            const plist = await getPlayersWithStatsByTeam(t.id, season);
            const xi = pickTopXI(plist);
            state.xiByTeam[t.id] = xi;
            buildAllTeamsXI(teams);
          }
          showStatus("");
        } catch (e) {
          console.error(e);
          showStatus("โหลดไม่ได้: " + (e.message || e));
        }
      }

      /* =====================[ expose / boot ]===================== */
      function resetBoards() {
        state.A = FORMATION.map((x) => ({ ...x, player: null }));
        state.B = FORMATION.map((x) => ({ ...x, player: null }));
        renderBoard("A", "formA");
        renderBoard("B", "formB");
        document.getElementById("result").textContent = "";
      }
      window.resetBoards = resetBoards;
      window.removeFromSlot = removeFromSlot;
      window.openLogoPicker = openLogoPicker;
      window.battle = battle;

      document.getElementById("btnLoad").onclick = loadLeague;
      renderBoard("A", "formA");
      renderBoard("B", "formB");
      // auto-load
      loadLeague();
    </script>
  </body>
</html>
